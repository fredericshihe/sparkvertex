# AI Workflow ä¸ Patch å®Œæ•´é“¾è·¯è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [AI Workflow å®Œæ•´é“¾è·¯](#ai-workflow-å®Œæ•´é“¾è·¯)
2. [Patch ç³»ç»Ÿå®Œæ•´é“¾è·¯](#patch-ç³»ç»Ÿå®Œæ•´é“¾è·¯)

---

## AI Workflow å®Œæ•´é“¾è·¯

### ğŸ¯ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·å‘é€ä¿®æ”¹è¯·æ±‚                                      â”‚
â”‚                     "æŠŠæŒ‰é’®é¢œè‰²æ”¹æˆçº¢è‰²" / "ä¿®å¤ç™»å½•Bug"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1: Intent Classification (æ„å›¾åˆ†ç±»)                                       â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/api/generate/route.ts â†’ classifyUserIntent()                     â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/intent-classifier.ts â†’ classifyIntentWithDeepSeek()              â”‚
â”‚  â””â”€â”€ è¾“å‡º: intent, targets[], referenceTargets[], reasoning                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 2: Code RAG (ä»£ç æ£€ç´¢å¢å¼ºç”Ÿæˆ)                                             â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/api/generate/route.ts â†’ findRelevantCodeChunks()                 â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/code-rag.ts â†’ chunkCode() + embedding similarity                 â”‚
â”‚  â””â”€â”€ è¾“å‡º: relevantChunks[] (ä¸ç”¨æˆ·è¯·æ±‚æœ€ç›¸å…³çš„ä»£ç ç‰‡æ®µ)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 3: Smart Compression (æ™ºèƒ½å‹ç¼©)                                           â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/api/generate/route.ts â†’ compressCode()                           â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/code-rag.ts â†’ AST Skeletonization / Brutal Truncate              â”‚
â”‚  â””â”€â”€ è¾“å‡º: compressedCode (å‹ç¼©åçš„ä»£ç ä¸Šä¸‹æ–‡, ~60% å‹ç¼©ç‡)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 4: LLM Generation (ä»£ç ç”Ÿæˆ)                                              â”‚
â”‚  â”œâ”€â”€ å…¥å£: Supabase Edge Function / å¤–éƒ¨ LLM API                                â”‚
â”‚  â”œâ”€â”€ è¾“å…¥: compressedCode + ragContext + userPrompt + System Prompt              â”‚
â”‚  â””â”€â”€ è¾“å‡º: <<<<SEARCH ... ==== REPLACE ... >>>> æ ¼å¼çš„ Patch                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 5: Patch Application (è¡¥ä¸åº”ç”¨)                                           â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/create/page.tsx â†’ applyPatches()                                 â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/patch.ts â†’ Multi-strategy Token/AST Matching                     â”‚
â”‚  â””â”€â”€ è¾“å‡º: ä¿®æ”¹åçš„å®Œæ•´æºä»£ç                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Stage 1: Intent Classification (æ„å›¾åˆ†ç±»)

**æ–‡ä»¶ä½ç½®**: `lib/intent-classifier.ts`

**æ ¸å¿ƒå‡½æ•°**: `classifyUserIntent()` â†’ `classifyIntentWithDeepSeek()`

**æµç¨‹**:
```
1. æ¥æ”¶ç”¨æˆ· Prompt + ä»£ç æ–‡ä»¶æ‘˜è¦ (fileSummaries)
                    â”‚
                    â–¼
2. ç”Ÿæˆæ–‡ä»¶æ‘˜è¦ (generateFileSummary)
   - æå–æ¯ä¸ªç»„ä»¶çš„ useState, useEffect, handlers, ä¾èµ–å…³ç³»
   - ç¤ºä¾‹: "MapScreen: uses [position, exploredTiles], effects: [player movement], handlers: [handleMove]"
                    â”‚
                    â–¼
3. æ„å»º DeepSeek Prompt
   - è§’è‰²: Senior Software Architect
   - ä»»åŠ¡: åˆ†æ files_to_edit (éœ€è¦ä¿®æ”¹) vs files_to_read (åªè¯»å‚è€ƒ)
   - è¾“å‡ºæ ¼å¼:
     {
       "reasoning": "ç”¨æˆ·è¦æ±‚...",
       "intent": "UI_MODIFICATION | LOGIC_FIX | NEW_FEATURE | ...",
       "files_to_edit": ["MapScreen", "BattleScene"],
       "files_to_read": ["CONSTANTS", "Types"]
     }
                    â”‚
                    â–¼
4. è°ƒç”¨ Supabase Edge Function â†’ DeepSeek API
   - è¶…æ—¶: 45s
   - æ¸©åº¦: 0.3 (åä¿å®ˆ)
   - Fallback: Gemini 2.5 Flash â†’ æœ¬åœ°è§„åˆ™
                    â”‚
                    â–¼
5. è§£æå“åº”
   - æå– JSON (æ”¯æŒ Markdown ä»£ç å—åŒ…è£¹)
   - éªŒè¯ intent æ˜¯å¦ä¸ºæœ‰æ•ˆæšä¸¾å€¼
   - ä» reasoning ä¸­æå–é—æ¼çš„æ–‡ä»¶å (Safety Net)
```

**æ„å›¾ç±»å‹ (UserIntent Enum)**:
| Intent | æè¿° | å‹ç¼©é˜ˆå€¼ |
|--------|------|----------|
| `UI_MODIFICATION` | é¢œè‰²ã€æ ·å¼ã€å¸ƒå±€ | 8 è¡Œ (æœ€æ¿€è¿›) |
| `LOGIC_FIX` | Bug ä¿®å¤ã€æ•°æ®æµ | 12 è¡Œ |
| `NEW_FEATURE` | æ–°å¢é¡µé¢/ç»„ä»¶ | 15 è¡Œ (æœ€ä¿å®ˆ) |
| `DATA_OPERATION` | æ•°æ®åº“ã€API | 12 è¡Œ |
| `REFACTOR` | ä»£ç é‡æ„ | 10 è¡Œ |
| `PERFORMANCE` | æ€§èƒ½ä¼˜åŒ– | 12 è¡Œ |
| `GLOBAL_REVIEW` | å…¨å±€æ£€æŸ¥ | ç‰¹æ®Šå¤„ç† |

---

### Stage 2: Code RAG (ä»£ç æ£€ç´¢å¢å¼º)

**æ–‡ä»¶ä½ç½®**: `lib/code-rag.ts`

**æ ¸å¿ƒå‡½æ•°**: `findRelevantCodeChunks()`

**æµç¨‹**:
```
1. ä»£ç åˆ†å— (chunkCode)
   - æŒ‰ const/function/class/export åˆ†å‰²
   - è¯†åˆ« React ç»„ä»¶ã€å¸¸é‡ã€å·¥å…·å‡½æ•°
   - æ¯ä¸ª Chunk å¸¦æœ‰: { id, content, type, dependencies }
                    â”‚
                    â–¼
2. å‘é‡åµŒå…¥ (Embedding)
   - å¯¹ç”¨æˆ· Prompt ç”Ÿæˆå‘é‡
   - å¯¹æ¯ä¸ª Chunk ç”Ÿæˆå‘é‡ (ç¼“å­˜ä¼˜åŒ–)
                    â”‚
                    â–¼
3. ç›¸ä¼¼åº¦è¯„åˆ† (Cosine Similarity)
   - è®¡ç®— Prompt ä¸æ¯ä¸ª Chunk çš„ç›¸ä¼¼åº¦
   - ç¤ºä¾‹: MapScreen=0.715, BattleScene=0.742
                    â”‚
                    â–¼
4. æ™ºèƒ½é€‰æ‹© ğŸ†• STRICT MODE
   - åŸºç¡€: ç›¸ä¼¼åº¦ > 0.55 çš„ Chunks
   - ä¼˜å…ˆçº§:
     a) Explicit Targets (Intent æŒ‡å®šçš„ files_to_edit) â†’ å…¨é‡ä¿ç•™
     b) Reference Targets (files_to_read) â†’ éª¨æ¶åŒ–
     c) ğŸ†• STRICT MODE: å½“ DeepSeek è¿”å›äº† targets æ—¶ï¼Œç¦ç”¨ "mentioned in prompt" æ¨¡ç³ŠåŒ¹é…
     d) Dependencies (è¢«ä¾èµ–çš„) â†’ é€’å½’å±•å¼€
   - é™åˆ¶: Max 11 Chunks (é˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡º)
                    â”‚
                    â–¼
5. ä¾èµ–å›¾æ‰©å±•
   - å¦‚æœé€‰ä¸­ MapScreen, è‡ªåŠ¨åŒ…å«å…¶ä¾èµ–: TILE_CLASSES, VISIBILITY_RADIUS
   - ä¼˜å…ˆé˜Ÿåˆ—: Explicit Targets çš„ä¾èµ– > å…¶ä»–
```

**ğŸ†• P0 ä¼˜åŒ–: STRICT MODE (ä¿¡ä»» DeepSeek)**
```typescript
// å½“ DeepSeek æä¾›äº† files_to_edit/files_to_read æ—¶
// å®Œå…¨ä¿¡ä»» DeepSeekï¼Œç¦ç”¨åŸºäºå­—ç¬¦ä¸²çš„æ¨¡ç³ŠåŒ¹é…
// é˜²æ­¢ "screen" åŒ¹é… "LaunchScreen", "DexScreen" ç­‰å™ªéŸ³

const TRUST_DEEPSEEK_ONLY = explicitTargets.length > 0 || referenceTargets.length > 0;

if (TRUST_DEEPSEEK_ONLY) {
    // åªå…è®¸ç²¾ç¡®åŒ¹é…å®Œæ•´ç»„ä»¶å
    // ç¦ç”¨ä¸­æ–‡å…³é”®è¯æ¨¡ç³ŠåŒ¹é…
}
```

**å‡½æ•°åâ†’çˆ¶æ–‡ä»¶è§£æ** (æ–°å¢ä¿®å¤):
```typescript
// å¦‚æœ DeepSeek è¿”å›å‡½æ•°å "handleMove" è€Œä¸æ˜¯ç»„ä»¶å "MapScreen"
// ç³»ç»Ÿä¼šè‡ªåŠ¨è§£æ: handleMove â†’ å®šä¹‰åœ¨ MapScreen â†’ ä¿ç•™ MapScreen å®Œæ•´ä»£ç 
```

---

### Stage 3: Smart Compression (æ™ºèƒ½å‹ç¼©)

**æ–‡ä»¶ä½ç½®**: `lib/code-rag.ts`

**æ ¸å¿ƒå‡½æ•°**: `compressCode()` â†’ `skeletonizeCode()`

**å‹ç¼©ç­–ç•¥åˆ†å±‚**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Primary Targets (Explicit Files to Edit)              â”‚
â”‚  ç­–ç•¥: ğŸ“ FULL CODE - å®Œæ•´ä¿ç•™ï¼Œä¸åšä»»ä½•å‹ç¼©                      â”‚
â”‚  ç¤ºä¾‹: MapScreen (ç”¨æˆ·æŒ‡å®šè¦ä¿®æ”¹çš„ç»„ä»¶)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Context References (files_to_read)                    â”‚
â”‚  ç­–ç•¥: ğŸ“– AST Skeleton - ä¿ç•™å‡½æ•°ç­¾åï¼Œéšè—å‡½æ•°ä½“                 â”‚
â”‚  ç¤ºä¾‹:                                                          â”‚
â”‚    // Before:                                                   â”‚
â”‚    function BattleScene({ player, enemy }) {                    â”‚
â”‚      const [hp, setHp] = useState(100);                         â”‚
â”‚      // ... 260 lines ...                                       â”‚
â”‚      return <div>...</div>                                      â”‚
â”‚    }                                                            â”‚
â”‚    // After:                                                    â”‚
â”‚    function BattleScene({ player, enemy }) {                    â”‚
â”‚      /* Body hidden: 45 statements */                           â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ†• Layer 3: Data/Config Files (Pure Constants)                 â”‚
â”‚  ç­–ç•¥: ğŸ“Š Data Skeletonization - ä¿ç•™æ‰€æœ‰ KEYï¼Œæˆªæ–­é•¿ VALUE      â”‚
â”‚  ğŸ†• P0 ä¼˜åŒ–: ä¸å†ä½¿ç”¨ Brutal Truncateï¼                          â”‚
â”‚  ç¤ºä¾‹:                                                          â”‚
â”‚    // Before: VISIBILITY_RADIUS (131 lines)                     â”‚
â”‚    export const VISIBILITY_RADIUS = 3;                          â”‚
â”‚    export const MAP_WIDTH = 20;                                 â”‚
â”‚    export const LARGE_ARRAY = [/* 100 items */];                â”‚
â”‚                                                                 â”‚
â”‚    // After: ä¿ç•™æ‰€æœ‰å¯¼å‡ºçš„ KEY åç§°ï¼                            â”‚
â”‚    export const VISIBILITY_RADIUS = 3;                          â”‚
â”‚    export const MAP_WIDTH = 20;                                 â”‚
â”‚    export const LARGE_ARRAY = [ /* 100 items - see source */ ]; â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: Irrelevant Modules (Non-data, Non-target)             â”‚
â”‚  ç­–ç•¥: ğŸ—œï¸ Brutal Truncate - åªä¿ç•™å‰ 10-15 è¡Œ                    â”‚
â”‚  é€‚ç”¨: éæ•°æ®æ–‡ä»¶çš„ä¸ç›¸å…³ä»£ç  (å¦‚ ShopScreen åœ¨ä¿®æ”¹ MapScreen æ—¶)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ†• P0 ä¼˜åŒ–: Data Skeletonization (æ•°æ®éª¨æ¶åŒ–)**
```typescript
// æ£€æµ‹çº¯æ•°æ®æ–‡ä»¶ (åªæœ‰ const exports, æ²¡æœ‰å‡½æ•°)
// ä¿ç•™æ‰€æœ‰å¯¼å‡ºçš„å˜é‡åï¼Œåªæˆªæ–­é•¿å€¼

function dataSkeletonize(code: string, chunkId: string) {
    // 1. æ£€æµ‹: æœ‰ exportsï¼Œæ—  functions
    const isPureDataFile = /export\s+const/.test(code) && 
                          !/function\s+\w+/.test(code);
    
    // 2. éå†æ‰€æœ‰ const å£°æ˜
    // 3. çŸ­å€¼ (<300 chars) â†’ å®Œæ•´ä¿ç•™
    // 4. é•¿å€¼ (æ•°ç»„/å¯¹è±¡) â†’ ä¿ç•™ç»“æ„ + "N items truncated"
}
```

**AST Skeletonization ç®—æ³•**:
```typescript
// ä½¿ç”¨ Babel Parser è§£æ â†’ traverse â†’ æ›¿æ¢å‡½æ•°ä½“
traverse(ast, {
    "FunctionDeclaration|ArrowFunctionExpression"(path) {
        if (bodySize > 100 || statements > 3) {
            path.get("body").replaceWith(
                t.blockStatement([]) // ç©ºå‡½æ•°ä½“
            );
            // æ·»åŠ æ³¨é‡Š: /* Body hidden: 45 statements */
        }
    }
});
```

---

### Stage 4: LLM Generation (ä»£ç ç”Ÿæˆ)

**è¾“å…¥æ„å»º**:
```
System Prompt (lib/prompts.ts):
â”œâ”€â”€ è§’è‰²å®šä¹‰: Expert React Developer
â”œâ”€â”€ è¾“å‡ºæ ¼å¼: <<<<SEARCH ... ==== REPLACE ... >>>>
â”œâ”€â”€ è§„åˆ™:
â”‚   â”œâ”€â”€ ä¸è¦å‡è®¾ä»£ç å­˜åœ¨ï¼Œä½¿ç”¨æä¾›çš„ä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ æ¯ä¸ª Patch å—è¦åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ ä¸è¦æ·»åŠ ä¸å­˜åœ¨çš„æ³¨é‡Š

User Prompt:
â”œâ”€â”€ compressedCode (å‹ç¼©åçš„å®Œæ•´ä»£ç )
â”œâ”€â”€ ragContext (RAG é€‰ä¸­çš„ä»£ç ç‰‡æ®µ)
â”œâ”€â”€ codeContext (ä¼˜åŒ–æç¤º)
â””â”€â”€ ç”¨æˆ·åŸå§‹è¯·æ±‚
```

**è¾“å‡ºæ ¼å¼**:
```diff
<<<<SEARCH
const MapScreen = ({ player, onMove }) => {
    const [position, setPosition] = useState({ x: 5, y: 5 });
====
const MapScreen = ({ player, onMove }) => {
    const [position, setPosition] = useState({ x: 5, y: 5 });
    const [fogOfWar, setFogOfWar] = useState(true); // æ–°å¢
>>>>
```

---

## Patch ç³»ç»Ÿå®Œæ•´é“¾è·¯

### ğŸ¯ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LLM è¾“å‡ºçš„ Patch æ–‡æœ¬                                  â”‚
â”‚         <<<<SEARCH ... ==== REPLACE ... >>>>  æˆ–  <<<<AST_REPLACE: Name>>>>     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 0: Patch æ ¼å¼æ£€æµ‹                                                          â”‚
â”‚  â”œâ”€â”€ AST_REPLACE æ ¼å¼ â†’ èµ° Explicit AST è·¯å¾„                                    â”‚
â”‚  â””â”€â”€ SEARCH/REPLACE æ ¼å¼ â†’ èµ° Token Matching è·¯å¾„                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Explicit AST Replacement   â”‚                   â”‚  Token-based Matching       â”‚
â”‚  (Scheme 2: Modular)        â”‚                   â”‚  (Scheme 1: Cursor-style)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                                     â”‚
              â–¼                                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  applyExplicitASTPatch()    â”‚                   â”‚  applyPatchesInternal()     â”‚
â”‚  ç›´æ¥å®šä½å˜é‡/å‡½æ•°åæ›¿æ¢       â”‚                   â”‚  å¤šç­–ç•¥åŒ¹é… (è§ä¸‹æ–¹è¯¦è§£)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Post-Validation (å®‰å…¨æ ¡éªŒ)                                                      â”‚
â”‚  â”œâ”€â”€ é•¿åº¦æ£€æŸ¥: ç»“æœä¸èƒ½å¤ªçŸ­ (<50% åŸå§‹) æˆ–å¤ªé•¿ (>300%)                            â”‚
â”‚  â”œâ”€â”€ è¯­æ³•ä¿®å¤: validateAndFixSyntax() - ä¿®å¤å¸¸è§è¯­æ³•é”™è¯¯                         â”‚
â”‚  â”œâ”€â”€ å®šä¹‰å»é‡: dedupeTopLevelBindings() - åˆ é™¤é‡å¤çš„å˜é‡/å‡½æ•°å®šä¹‰                 â”‚
â”‚  â”œâ”€â”€ å¼•ç”¨æ£€æµ‹: detectUndefinedReferences() - æ£€æµ‹åˆ é™¤äº†ä½†ä»è¢«å¼•ç”¨çš„ç»„ä»¶            â”‚
â”‚  â””â”€â”€ å›æ»šæœºåˆ¶: ä»»ä½•æ ¡éªŒå¤±è´¥ â†’ è¿”å›åŸå§‹ä»£ç                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Token Matching å¤šç­–ç•¥ç€‘å¸ƒ (æ ¸å¿ƒç®—æ³•)

**æ–‡ä»¶ä½ç½®**: `lib/patch.ts`

**æ ¸å¿ƒå‡½æ•°**: `applyPatchesInternal()`

**ğŸ†• Token Normalization (P2 ä¼˜åŒ–)**

åœ¨æ‰€æœ‰ Token åŒ¹é…ç­–ç•¥æ‰§è¡Œå‰ï¼Œé¦–å…ˆå¯¹ Token è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œæ¶ˆé™¤å› å¼•å·é£æ ¼ã€å¯é€‰åˆ†å·ç­‰å¯¼è‡´çš„è™šå‡ä¸åŒ¹é…ï¼š

```typescript
/**
 * Token Normalization Rules:
 * 1. å¼•å·å½’ä¸€åŒ–: " â†’ ', ` â†’ '  (åŒå¼•å·/æ¨¡æ¿å­—ç¬¦ä¸² ç»Ÿä¸€ä¸º å•å¼•å·)
 * 2. åˆ†å·å½’ä¸€åŒ–: åœ¨ JS/TS ä¸­åˆ†å·æ˜¯å¯é€‰çš„ï¼Œä¸åº”å¯¼è‡´åŒ¹é…å¤±è´¥
 * 
 * ç¤ºä¾‹åœºæ™¯:
 * - AI è¾“å‡º: const name = "value"
 * - æºç :   const name = 'value'
 * - å½’ä¸€åŒ–å: ä¸¤è€… Token åºåˆ—ç›¸åŒï¼ŒåŒ¹é…æˆåŠŸ
 */

interface Token {
    text: string;      // åŸå§‹æ–‡æœ¬
    normalized: string; // ğŸ†• å½’ä¸€åŒ–åæ–‡æœ¬
    start: number;
    end: number;
}

function normalizeToken(text: string): string {
    // Rule 1: å¼•å·å½’ä¸€åŒ–
    if (text === '"' || text === '`') return "'";
    return text;
}

// æ¯”è¾ƒå‡½æ•°ä¼˜å…ˆä½¿ç”¨å½’ä¸€åŒ–åçš„å€¼
function tokensEqual(a: Token, b: Token): boolean {
    if (a.text === b.text) return true; // å¿«é€Ÿè·¯å¾„
    return a.normalized === b.normalized; // å½’ä¸€åŒ–æ¯”è¾ƒ
}
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 0: AST Smart Patch (å˜é‡/å‡½æ•°æ•´ä½“æ›¿æ¢)                                  â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: replaceBlock æ˜¯å®Œæ•´çš„ const/function å®šä¹‰                         â”‚
â”‚  â”œâ”€â”€ ç®—æ³•: è§£æ replaceBlock AST â†’ æå–å˜é‡å â†’ åœ¨æºç ä¸­å®šä½åŒåå®šä¹‰ â†’ æ•´ä½“æ›¿æ¢    â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: const MONSTERS = [...] æ•´ä½“æ›¿æ¢                                      â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 1: Exact Token Match (ç²¾ç¡® Token åŒ¹é…)                                 â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. tokenize(searchBlock) â†’ ['const', 'x', '=', '1', ';']                  â”‚
â”‚  â”‚   2. tokenize(sourceCode) â†’ [...å…¨éƒ¨ tokens...]                             â”‚
â”‚  â”‚   3. æ»‘åŠ¨çª—å£: è¿ç»­åŒ¹é…æ‰€æœ‰ search tokens                                     â”‚
â”‚  â”œâ”€â”€ ç‰¹ç‚¹: å¿½ç•¥ç©ºæ ¼/æ¢è¡Œï¼Œåªæ¯”è¾ƒè¯­ä¹‰å•å…ƒ                                          â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: "const  x=1" å¯ä»¥åŒ¹é… "const x = 1"                                  â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 1.5: Comment-Insensitive Match (æ³¨é‡Šæ— å…³åŒ¹é…) ğŸ†•                       â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: ç²¾ç¡®åŒ¹é…å¤±è´¥ + searchBlock åŒ…å«æ³¨é‡Š                                â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. stripComments(searchBlock) - ç§»é™¤æ‰€æœ‰æ³¨é‡Š                               â”‚
â”‚  â”‚   2. ç”¨å»æ³¨é‡Šçš„ tokens é‡æ–°è¿›è¡Œ Relaxed Match                                â”‚
â”‚  â”œâ”€â”€ ç›®çš„: è§£å†³ AI å¹»è§‰æ·»åŠ æ³¨é‡Š (å¦‚ {/* Fog of War */}) çš„é—®é¢˜                   â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: AI è¾“å‡ºåŒ…å«æ³¨é‡Šï¼Œä½†æºç æ— æ³¨é‡Š â†’ ä»ç„¶èƒ½åŒ¹é…                              â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 2: Relaxed Token Match (å®½æ¾ Token åŒ¹é…)                               â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: relaxedMode = true (ä¸Šä¼ çš„ä»£ç é¦–æ¬¡ç¼–è¾‘)                            â”‚
â”‚  â”œâ”€â”€ ç®—æ³•: LCS (Longest Common Subsequence)                                     â”‚
â”‚  â”‚   - å…è®¸è·³è¿‡éƒ¨åˆ† tokens (å®¹å¿è½»å¾®å·®å¼‚)                                        â”‚
â”‚  â”‚   - é˜ˆå€¼: åŒ¹é…ç‡ > 70%                                                       â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: æºç å¤šäº†ç©ºè¡Œæˆ–æ³¨é‡Šï¼Œä»èƒ½åŒ¹é…                                           â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 3: AST Lite - Function Body Match (å‡½æ•°ä½“åŒ¹é…)                         â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. ä» searchBlock æå–å‡½æ•°å (å¦‚ handleMove)                               â”‚
â”‚  â”‚   2. åœ¨æºç ä¸­å®šä½è¯¥å‡½æ•°çš„å®Œæ•´èŒƒå›´ (start-end)                                  â”‚
â”‚  â”‚   3. æ•´ä½“æ›¿æ¢å‡½æ•°ä½“                                                          â”‚
â”‚  â”œâ”€â”€ ç‰¹ç‚¹: ä¸éœ€è¦ç²¾ç¡®åŒ¹é…å†…å®¹ï¼Œåªéœ€å‡½æ•°ååŒ¹é…                                      â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: function handleMove() {...} æ•´ä½“æ›¿æ¢                                 â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 4: Anchor Matching (é”šç‚¹åŒ¹é…)                                          â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: searchBlock åŒ…å«å‹ç¼©æ ‡è®° æˆ– å…¶ä»–ç­–ç•¥å…¨éƒ¨å¤±è´¥                        â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. å– searchBlock é¦–è¡Œ + æœ«è¡Œä½œä¸º"é”šç‚¹"                                     â”‚
â”‚  â”‚   2. åœ¨æºç ä¸­æŸ¥æ‰¾: é¦–è¡Œå‡ºç°ä½ç½® â†’ åœ¨å…¶å 500 è¡Œå†…æŸ¥æ‰¾æœ«è¡Œ                       â”‚
â”‚  â”‚   3. ç”¨ [é¦–è¡Œä½ç½®, æœ«è¡Œä½ç½®] å®šä¹‰æ›¿æ¢èŒƒå›´                                      â”‚
â”‚  â”œâ”€â”€ ç‰¹ç‚¹: ä¸­é—´å†…å®¹æ— å…³ï¼Œåªå…³å¿ƒè¾¹ç•Œ                                               â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: é¦–è¡Œ "const MapScreen = () => {" + æœ«è¡Œ "};" â†’ å®šä½æ•´ä¸ªç»„ä»¶           â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ æŠ›å‡ºé”™è¯¯                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Safety Nets (å®‰å…¨ç½‘æœºåˆ¶)

**Safety Net 1: AST Dedupe (å»é‡)**
```typescript
// æ£€æµ‹å¹¶åˆ é™¤é‡å¤çš„é¡¶å±‚å®šä¹‰
// åœºæ™¯: AI åŒæ—¶è¾“å‡ºäº†æ–°ç‰ˆæœ¬å’Œä¿ç•™äº†æ—§ç‰ˆæœ¬
dedupeTopLevelBindings(code);
// ç¤ºä¾‹: ä¸¤ä¸ª const MapScreen = ... â†’ åªä¿ç•™åè€…
```

**Safety Net 2: Undefined Reference Detection**
```typescript
// æ£€æµ‹åˆ é™¤äº†å®šä¹‰ä½†ä»æœ‰å¼•ç”¨çš„æƒ…å†µ
detectUndefinedReferences(code);
// ç¤ºä¾‹: AI åˆ é™¤äº† BattleScene å®šä¹‰ï¼Œä½† <BattleScene /> ä»å­˜åœ¨ â†’ å›æ»š
```

**Safety Net 3: Incremental Validation**
```typescript
// æ¯ä¸ª Patch åº”ç”¨åç«‹å³æ ¡éªŒ
validateIncrementalPatch(previousSource, newSource, originalDefinitions, patchIndex);
// æ£€æŸ¥:
// - è¯­æ³•æ˜¯å¦åˆæ³• (Babel parse)
// - æ˜¯å¦ä¸¢å¤±äº†ç»„ä»¶å®šä¹‰
// - æ˜¯å¦äº§ç”Ÿäº†å­¤å„¿ä»£ç  (é¡¶å±‚çš„ hooks è°ƒç”¨)
```

**Safety Net 4: Target Range Restriction**
```typescript
// é™åˆ¶ Patch åªèƒ½åº”ç”¨åˆ° Intent æŒ‡å®šçš„æ–‡ä»¶èŒƒå›´å†…
allowedRanges = findTargetRanges(source, targets);
// é˜²æ­¢: AI çš„ searchBlock æ„å¤–åŒ¹é…åˆ°é”™è¯¯çš„ä½ç½®
```

**ğŸ†• Safety Net 5: Anchor Uniqueness Check (P1 ä¼˜åŒ–)**
```typescript
// ğŸ†• P1 ä¼˜åŒ–: é”šç‚¹åŒ¹é…å‰æ£€æŸ¥é¦–è¡Œæ˜¯å¦å”¯ä¸€
const startOccurrences = sourceLines.filter(l => l.trim() === startLine).length;

if (startOccurrences > 1) {
    console.log(`âš ï¸ Start anchor is not unique (${startOccurrences} occurrences), expanding...`);
    // æ‰©å±•é”šç‚¹: ä½¿ç”¨å‰ 2 è¡Œç»„åˆåŒ¹é…
    const combinedStart = searchLines[0] + '\n' + searchLines[1];
    // æ‰¾åˆ°å”¯ä¸€åŒ¹é…åå†ç»§ç»­
}
```

**ğŸ†• Safety Net 6: Transactional Patching (P1 ä¼˜åŒ–)**
```typescript
// ğŸ†• P1 ä¼˜åŒ–: äº‹åŠ¡æ€§ Patch åº”ç”¨
// æ‰€æœ‰ Patch åœ¨ workingSource å‰¯æœ¬ä¸Šæ‰§è¡Œ
// åªæœ‰å…¨éƒ¨æˆåŠŸæ‰è¿”å›ä¿®æ”¹åçš„ä»£ç 

let workingSource = source; // å·¥ä½œå‰¯æœ¬
const appliedPatches: { index: number; before: string; after: string }[] = [];

// åº”ç”¨æ¯ä¸ª Patch...
appliedPatches.push({ index, before: previousSource, after: workingSource });

// æœ€ç»ˆæ£€æŸ¥
if (failCount > 0 && successCount === 0) {
    throw new Error('æ— æ³•åº”ç”¨ä¿®æ”¹'); // å®Œå…¨å¤±è´¥
}

console.log(`âœ… TRANSACTION COMPLETE: ${successCount} patches applied`);
return workingSource;
```

---

### stripComments å®ç° (æ³¨é‡Šå‰¥ç¦»)

```typescript
function stripComments(code: string): string {
    return code
        .replace(/\{\/\*[\s\S]*?\*\/\}/g, '') // JSX æ³¨é‡Š {/* ... */} (å¿…é¡»å…ˆå¤„ç†)
        .replace(/\/\*[\s\S]*?\*\//g, '')     // å—æ³¨é‡Š /* ... */
        .replace(/\/\/.*/g, '');              // è¡Œæ³¨é‡Š // ...
}
```

**ä¸ºä»€ä¹ˆ JSX æ³¨é‡Šè¦å…ˆå¤„ç†?**
```jsx
// é”™è¯¯é¡ºåº (å…ˆå¤„ç†å—æ³¨é‡Š):
{/* comment */}  â†’  { }  // ç•™ä¸‹ç©ºå¤§æ‹¬å·ï¼Œç ´å JSX

// æ­£ç¡®é¡ºåº (å…ˆå¤„ç† JSX æ³¨é‡Š):
{/* comment */}  â†’  (ç©º)  // å®Œæ•´åˆ é™¤
```

---

### Patch å¤±è´¥å¸¸è§åŸå› 

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `æ‰¾ä¸åˆ°åŒ¹é…çš„ä»£ç å—` | AI çš„ SEARCH å—ä¸æºç ä¸åŒ¹é… | Comment-Insensitive Match (å·²å®ç°) |
| `Patch ç»“æœè¿‡çŸ­` | AI åªè¾“å‡ºäº†éƒ¨åˆ†ä»£ç  | é•¿åº¦æ ¡éªŒ + å›æ»š |
| `é‡å¤å®šä¹‰` | AI æ²¡æœ‰åˆ é™¤æ—§ä»£ç  | AST Dedupe |
| `æœªå®šä¹‰å¼•ç”¨` | AI åˆ é™¤äº†ç»„ä»¶ä½†ç•™ä¸‹äº†ä½¿ç”¨ | Undefined Reference Detection |
| `è¯­æ³•é”™è¯¯` | AI è¾“å‡ºäº†ä¸å®Œæ•´çš„ä»£ç  | validateAndFixSyntax() è‡ªåŠ¨ä¿®å¤ |
| ğŸ†• `é”šç‚¹ä¸å”¯ä¸€` | å¤šä¸ªç›¸åŒçš„ useEffect/å‡½æ•°ç­¾å | Anchor Uniqueness Check + æ‰©å±•é”šç‚¹ |

---

## ğŸ†• ä¼˜åŒ–å†å² (Changelog)

### 2025-12-11 P2 ä¼˜åŒ–

**P2 ä¼˜åŒ– (æŒç»­æ”¹è¿›)**:
5. **Token Normalization**: Token å½’ä¸€åŒ–æå‡åŒ¹é…å®¹é”™
   - è§£å†³: å¼•å·é£æ ¼å·®å¼‚ (`"foo"` vs `'foo'`) å¯¼è‡´çš„è™šå‡ä¸åŒ¹é…
   - æ–°å‡½æ•°: `normalizeToken()`, `tokensEqual()`, `tokenTextEqual()`
   - è§„åˆ™: åŒå¼•å·/æ¨¡æ¿å­—ç¬¦ä¸² â†’ å•å¼•å·å½’ä¸€åŒ–
   - æ–‡ä»¶: `lib/patch.ts`

### 2025-12-11 P0/P1 ä¼˜åŒ–

**P0 ä¼˜åŒ– (ç«‹å³ä¿®å¤)**:
1. **STRICT MODE for RAG**: å½“ DeepSeek è¿”å› targets æ—¶ï¼Œç¦ç”¨ "mentioned in prompt" æ¨¡ç³ŠåŒ¹é…
   - è§£å†³: "screen" åŒ¹é… "LaunchScreen", "DexScreen" çš„å™ªéŸ³é—®é¢˜
   - æ–‡ä»¶: `lib/code-rag.ts`

2. **Data Skeletonization**: çº¯æ•°æ®æ–‡ä»¶ä¸å†ä½¿ç”¨ Brutal Truncate
   - è§£å†³: `VISIBILITY_RADIUS` ç­‰å¸¸é‡è¢«æˆªæ–­ä¸¢å¤±å€¼çš„é—®é¢˜
   - æ–°å‡½æ•°: `dataSkeletonize()` - ä¿ç•™æ‰€æœ‰å¯¼å‡º KEYï¼Œåªæˆªæ–­é•¿ VALUE
   - æ–‡ä»¶: `lib/code-rag.ts`

**P1 ä¼˜åŒ– (çŸ­æœŸ)**:
3. **Anchor Uniqueness Check**: é”šç‚¹åŒ¹é…å‰æ£€æŸ¥é¦–è¡Œå”¯ä¸€æ€§
   - è§£å†³: å¤šä¸ªç›¸åŒ `useEffect` å¯¼è‡´åŒ¹é…é”™ä½çš„é—®é¢˜
   - ç­–ç•¥: é¦–è¡Œä¸å”¯ä¸€æ—¶ï¼Œè‡ªåŠ¨æ‰©å±•ä¸ºå‰ 2 è¡Œç»„åˆåŒ¹é…
   - æ–‡ä»¶: `lib/patch.ts`

4. **Transactional Patching**: äº‹åŠ¡æ€§ Patch åº”ç”¨
   - è§£å†³: éƒ¨åˆ† Patch å¤±è´¥å¯¼è‡´ä»£ç "åŠæ­»ä¸æ´»"çš„é—®é¢˜
   - ç­–ç•¥: åœ¨å‰¯æœ¬ä¸Šæ‰§è¡Œæ‰€æœ‰ Patchï¼Œå…¨éƒ¨æˆåŠŸæ‰æäº¤
   - æ–‡ä»¶: `lib/patch.ts`

---

## é™„å½•: å…³é”®é…ç½®

### Babel Parser é…ç½®
```typescript
export const BABEL_PARSER_CONFIG = {
    sourceType: 'module',
    plugins: [
        'jsx', 'typescript', 'decorators-legacy', 
        'classProperties', 'objectRestSpread',
        'optionalChaining', 'nullishCoalescingOperator',
        'dynamicImport', 'exportDefaultFrom'
    ],
    errorRecovery: true
};
```

### Token åŒ–æ­£åˆ™ (å¸¦å½’ä¸€åŒ–)
```typescript
// åŸºç¡€ Token æå–
const regex = /([a-zA-Z0-9_$]+)|([^\s\w])/g;
// åŒ¹é…:
// - æ ‡è¯†ç¬¦: myVar, useState, $element
// - ç¬¦å·: {, }, (, ), =, ;, <, >
// ä¸åŒ¹é…:
// - ç©ºç™½å­—ç¬¦ (ç©ºæ ¼, æ¢è¡Œ, Tab)

// ğŸ†• Token å½’ä¸€åŒ–
function normalizeToken(text: string): string {
    if (text === '"' || text === '`') return "'";  // å¼•å·å½’ä¸€åŒ–
    return text;
}
```

---

*æœ€åæ›´æ–°: 2025-12-11*
