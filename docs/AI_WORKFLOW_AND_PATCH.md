# AI Workflow ä¸ Patch å®Œæ•´é“¾è·¯è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [AI Workflow å®Œæ•´é“¾è·¯](#ai-workflow-å®Œæ•´é“¾è·¯)
3. [Patch ç³»ç»Ÿå®Œæ•´é“¾è·¯](#patch-ç³»ç»Ÿå®Œæ•´é“¾è·¯)
4. [ğŸš€ é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾](#é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾-advanced-optimization-roadmap)
5. [é«˜çº§ RAG ä¼˜åŒ–](#é«˜çº§-rag-ä¼˜åŒ–)
6. [è‡ªæ„ˆå¾ªç¯ç³»ç»Ÿ](#è‡ªæ„ˆå¾ªç¯ç³»ç»Ÿ)
7. [æ–‡ä»¶æ˜ å°„ä¸å¯¼å‡ºå‡½æ•°](#æ–‡ä»¶æ˜ å°„ä¸å¯¼å‡ºå‡½æ•°)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AI Workflow System (AI å·¥ä½œæµç³»ç»Ÿ)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   ç”¨æˆ·è¯·æ±‚ â”€â”€â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                  â”‚ Text Cache  â”‚â”€â”€â”€â–¶â”‚   Intent    â”‚â”€â”€â”€â–¶â”‚ Search      â”‚          â”‚
â”‚                  â”‚ (è¯­ä¹‰ç¼“å­˜)  â”‚    â”‚ Classifier  â”‚    â”‚ Strategy    â”‚          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                         â”‚                  â”‚                  â”‚                 â”‚
â”‚                         â–¼                  â–¼                  â–¼                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                  â”‚ Cache Hit?  â”‚    â”‚ Local/LLM   â”‚    â”‚ GraphRAG    â”‚          â”‚
â”‚                  â”‚ (75% ç›¸ä¼¼)  â”‚    â”‚ Fallback    â”‚    â”‚ ä¾èµ–å›¾æ‰©å±•   â”‚          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                              â”‚                  â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                         â–¼                                                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                  â”‚              Code RAG System (ä»£ç æ£€ç´¢)               â”‚        â”‚
â”‚                  â”‚  â€¢ P3: è¯­ä¹‰å‹ç¼©é¢„å¤„ç† (semanticPrecompress)            â”‚        â”‚
â”‚                  â”‚  â€¢ P2: å‡½æ•°çº§åˆ«åˆ†å— (AST-based chunking)              â”‚        â”‚
â”‚                  â”‚  â€¢ å‘é‡åµŒå…¥ + pgvector æœç´¢                            â”‚        â”‚
â”‚                  â”‚  â€¢ P2: GraphRAG ä¸Šä¸‹æ–‡æ‰©å±•                             â”‚        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                          â”‚                                      â”‚
â”‚                                          â–¼                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                  â”‚              AI Generation (LLM ç”Ÿæˆ)                 â”‚        â”‚
â”‚                  â”‚  â€¢ Gemini 2.5 Flash / Pro / 3 Pro                    â”‚        â”‚
â”‚                  â”‚  â€¢ ä¸Šä¸‹æ–‡: æ„å›¾ + ç›®æ ‡æ–‡ä»¶ + å‚è€ƒä»£ç                    â”‚        â”‚
â”‚                  â”‚  â€¢ è¾“å‡º: SEARCH/REPLACE è¡¥ä¸æ ¼å¼ (æ”¯æŒè¡Œå·é”šå®š)         â”‚        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                          â”‚                                      â”‚
â”‚                                          â–¼                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                  â”‚              Patch System (è¡¥ä¸åº”ç”¨)                  â”‚        â”‚
â”‚                  â”‚  â€¢ P1: è¡Œå·é”šå®šä¼˜å…ˆ (@L42-L58)                        â”‚        â”‚
â”‚                  â”‚  â€¢ AST Smart Patch                                    â”‚        â”‚
â”‚                  â”‚  â€¢ Token ç²¾ç¡®/æ¨¡ç³ŠåŒ¹é… (Levenshtein)                   â”‚        â”‚
â”‚                  â”‚  â€¢ å¤šå±‚å®‰å…¨ç½‘: è¯­æ³•/å¼•ç”¨/é•¿åº¦éªŒè¯                        â”‚        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                          â”‚                                      â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                            â–¼                           â–¼                        â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                     â”‚  Success  â”‚               â”‚  Failure  â”‚                   â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                            â”‚                           â”‚                        â”‚
â”‚                            â–¼                           â–¼                        â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                  â”‚ Reflection Checkâ”‚         â”‚ Self-Repair     â”‚                â”‚
â”‚                  â”‚ (åæ€ä»£ç†)       â”‚         â”‚ (è‡ªæ„ˆå¾ªç¯)       â”‚                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                            â”‚                           â”‚                        â”‚
â”‚                            â–¼                           â–¼                        â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                  â”‚ âœ… å®Œæˆ         â”‚         â”‚ é‡æ–°ç”Ÿæˆè¡¥ä¸      â”‚                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ (æœ€å¤š 2 æ¬¡é‡è¯•)   â”‚                â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **æ¸è¿›å¼ä¼˜åŒ–** | ä¼˜å…ˆä½¿ç”¨å¿«é€Ÿæ–¹æ³• (æœ¬åœ°ç¼“å­˜/è§„åˆ™)ï¼Œå¤±è´¥æ—¶é€æ­¥å°è¯•æ›´å¤æ‚çš„ç­–ç•¥ (LLM) |
| **å®‰å…¨ç¬¬ä¸€** | å¤šå±‚éªŒè¯ç¡®ä¿è¡¥ä¸ä¸ä¼šç ´åç°æœ‰ä»£ç ï¼Œä»»ä½•å¼‚å¸¸ç«‹å³å›æ»š |
| **æ™ºèƒ½ç¼“å­˜** | Text Cache + Semantic Cache å‡å°‘ LLM è°ƒç”¨ï¼Œæå‡å“åº”é€Ÿåº¦ |
| **äº‹åŠ¡æ€§è¡¥ä¸** | æ‰€æœ‰è¡¥ä¸åœ¨å‰¯æœ¬ä¸Šæ‰§è¡Œï¼Œå…¨éƒ¨æˆåŠŸæ‰æäº¤ |
| **å¯è§‚æµ‹æ€§** | è¯¦ç»†æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•å’Œä¼˜åŒ– |

---

## AI Workflow å®Œæ•´é“¾è·¯

### ğŸ¯ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·å‘é€ä¿®æ”¹è¯·æ±‚                                      â”‚
â”‚                     "æŠŠæŒ‰é’®é¢œè‰²æ”¹æˆçº¢è‰²" / "ä¿®å¤ç™»å½•Bug"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1: Intent Classification (æ„å›¾åˆ†ç±»)                                       â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/api/generate/route.ts â†’ classifyUserIntent()                     â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/intent-classifier.ts â†’ classifyIntentWithDeepSeek()              â”‚
â”‚  â””â”€â”€ è¾“å‡º: intent, targets[], referenceTargets[], reasoning                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 2: Code RAG (ä»£ç æ£€ç´¢å¢å¼ºç”Ÿæˆ)                                             â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/api/generate/route.ts â†’ findRelevantCodeChunks()                 â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/code-rag.ts â†’ chunkCode() + embedding similarity                 â”‚
â”‚  â””â”€â”€ è¾“å‡º: relevantChunks[] (ä¸ç”¨æˆ·è¯·æ±‚æœ€ç›¸å…³çš„ä»£ç ç‰‡æ®µ)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 3: Smart Compression (æ™ºèƒ½å‹ç¼©)                                           â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/api/generate/route.ts â†’ compressCode()                           â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/code-rag.ts â†’ AST Skeletonization / Brutal Truncate              â”‚
â”‚  â””â”€â”€ è¾“å‡º: compressedCode (å‹ç¼©åçš„ä»£ç ä¸Šä¸‹æ–‡, ~60% å‹ç¼©ç‡)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 4: LLM Generation (ä»£ç ç”Ÿæˆ)                                              â”‚
â”‚  â”œâ”€â”€ å…¥å£: Supabase Edge Function / å¤–éƒ¨ LLM API                                â”‚
â”‚  â”œâ”€â”€ è¾“å…¥: compressedCode + ragContext + userPrompt + System Prompt              â”‚
â”‚  â””â”€â”€ è¾“å‡º: <<<<SEARCH ... ==== REPLACE ... >>>> æ ¼å¼çš„ Patch                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 5: Patch Application (è¡¥ä¸åº”ç”¨)                                           â”‚
â”‚  â”œâ”€â”€ å…¥å£: app/create/page.tsx â†’ applyPatches()                                 â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒ: lib/patch.ts â†’ Multi-strategy Token/AST Matching                     â”‚
â”‚  â””â”€â”€ è¾“å‡º: ä¿®æ”¹åçš„å®Œæ•´æºä»£ç                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Stage 1: Intent Classification (æ„å›¾åˆ†ç±»)

**æ–‡ä»¶ä½ç½®**: `lib/intent-classifier.ts`

**æ ¸å¿ƒå‡½æ•°**: `classifyUserIntent()` â†’ `classifyIntentWithDeepSeek()`

**ğŸ†• Text Cache é›†æˆ (2025-01-15)**

åœ¨è°ƒç”¨ LLM ä¹‹å‰ï¼Œé¦–å…ˆæŸ¥è¯¢ Text Cacheï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Intent Classification Pipeline                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   ç”¨æˆ·è¾“å…¥: "æŠŠæŒ‰é’®é¢œè‰²æ”¹æˆçº¢è‰²"                                       â”‚
â”‚                 â”‚                                                   â”‚
â”‚                 â–¼                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚  1. Text Cache æŸ¥è¯¢         â”‚   <â”€â”€ ğŸ†• è¯­ä¹‰ç¼“å­˜                  â”‚
â”‚   â”‚  n-gram Jaccard â‰¥ 0.75?     â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚          â”‚ HIT              â”‚ MISS                                  â”‚
â”‚          â–¼                  â–¼                                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚    â”‚ è¿”å›ç¼“å­˜   â”‚   â”‚  2. æœ¬åœ°å…³é”®è¯åŒ¹é…       â”‚                      â”‚
â”‚    â”‚ (<1ms)    â”‚   â”‚  INTENT_KEYWORDS Map    â”‚                      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚ ç½®ä¿¡åº¦ > 0.7?        â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                  â”‚ YES          â”‚ NO                                â”‚
â”‚                  â–¼              â–¼                                   â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚            â”‚ ç›´æ¥è¿”å›   â”‚  â”‚ 3. DeepSeek API     â”‚                   â”‚
â”‚            â”‚ (å¿«é€Ÿè·¯å¾„) â”‚  â”‚ (å¢å¼ºåˆ†ç±»)           â”‚                   â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                â”‚                                    â”‚
â”‚                                â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚  4. æå–ç›®æ ‡æ–‡ä»¶å       â”‚                      â”‚
â”‚                    â”‚  extractFileNamesFromTextâ”‚                     â”‚
â”‚                    â”‚  PascalCase åŒ¹é…         â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                    â”‚
â”‚                                â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚  5. å­˜å…¥ Text Cache     â”‚   <â”€â”€ ğŸ†•              â”‚
â”‚                    â”‚  (TTL: 30min)           â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æµç¨‹**:
```
1. æ¥æ”¶ç”¨æˆ· Prompt + ä»£ç æ–‡ä»¶æ‘˜è¦ (fileSummaries)
                    â”‚
                    â–¼
2. ç”Ÿæˆæ–‡ä»¶æ‘˜è¦ (generateFileSummary)
   - æå–æ¯ä¸ªç»„ä»¶çš„ useState, useEffect, handlers, ä¾èµ–å…³ç³»
   - ç¤ºä¾‹: "MapScreen: uses [position, exploredTiles], effects: [player movement], handlers: [handleMove]"
                    â”‚
                    â–¼
3. æ„å»º DeepSeek Prompt
   - è§’è‰²: Senior Software Architect
   - ä»»åŠ¡: åˆ†æ files_to_edit (éœ€è¦ä¿®æ”¹) vs files_to_read (åªè¯»å‚è€ƒ)
   - è¾“å‡ºæ ¼å¼:
     {
       "reasoning": "ç”¨æˆ·è¦æ±‚...",
       "intent": "UI_MODIFICATION | LOGIC_FIX | NEW_FEATURE | ...",
       "files_to_edit": ["MapScreen", "BattleScene"],
       "files_to_read": ["CONSTANTS", "Types"]
     }
                    â”‚
                    â–¼
4. è°ƒç”¨ Supabase Edge Function â†’ DeepSeek API
   - è¶…æ—¶: 45s
   - æ¸©åº¦: 0.3 (åä¿å®ˆ)
   - Fallback: Gemini 2.5 Flash â†’ æœ¬åœ°è§„åˆ™
                    â”‚
                    â–¼
5. è§£æå“åº”
   - æå– JSON (æ”¯æŒ Markdown ä»£ç å—åŒ…è£¹)
   - éªŒè¯ intent æ˜¯å¦ä¸ºæœ‰æ•ˆæšä¸¾å€¼
   - ä» reasoning ä¸­æå–é—æ¼çš„æ–‡ä»¶å (Safety Net)
```

**æ„å›¾ç±»å‹ (UserIntent Enum)**:
| Intent | æè¿° | å‹ç¼©é˜ˆå€¼ |
|--------|------|----------|
| `UI_MODIFICATION` | é¢œè‰²ã€æ ·å¼ã€å¸ƒå±€ | 8 è¡Œ (æœ€æ¿€è¿›) |
| `LOGIC_FIX` | Bug ä¿®å¤ã€æ•°æ®æµ | 12 è¡Œ |
| `NEW_FEATURE` | æ–°å¢é¡µé¢/ç»„ä»¶ | 15 è¡Œ (æœ€ä¿å®ˆ) |
| `DATA_OPERATION` | æ•°æ®åº“ã€API | 12 è¡Œ |
| `REFACTOR` | ä»£ç é‡æ„ | 10 è¡Œ |
| `PERFORMANCE` | æ€§èƒ½ä¼˜åŒ– | 12 è¡Œ |
| `GLOBAL_REVIEW` | å…¨å±€æ£€æŸ¥ | ç‰¹æ®Šå¤„ç† |

---

### Stage 2: Code RAG (ä»£ç æ£€ç´¢å¢å¼º)

**æ–‡ä»¶ä½ç½®**: `lib/code-rag.ts`

**æ ¸å¿ƒå‡½æ•°**: `findRelevantCodeChunks()`

**æµç¨‹**:
```
1. ğŸ†• è¯­ä¹‰å‹ç¼©é¢„å¤„ç† (P3 ä¼˜åŒ–: semanticPrecompress)
   - åˆ é™¤å•è¡Œæ³¨é‡Š (ä¿ç•™ JSDoc)
   - åˆå¹¶è¿ç»­ç©ºè¡Œ (æœ€å¤š 1 ä¸ª)
   - åˆ é™¤ console.log/debug è¯­å¥
   - æˆªæ–­è¶…é•¿å­—ç¬¦ä¸² (>200 å­—ç¬¦)
   - æ•ˆæœ: èŠ‚çœ 15-25% Token
                    â”‚
                    â–¼
2. ğŸ†• å‡½æ•°çº§åˆ†å— (P2 ä¼˜åŒ–: AST-based chunking)
   - ä½¿ç”¨ Babel Parser è§£æ AST
   - æŒ‰ React ç»„ä»¶/å‡½æ•°/å¸¸é‡è¾¹ç•Œåˆ†å—
   - ä¿ç•™å®Œæ•´å‡½æ•°ä¸Šä¸‹æ–‡
   - æ¯ä¸ª Chunk: { id, content, type, dependencies }
                    â”‚
                    â–¼
3. å‘é‡åµŒå…¥ (Embedding)
   - Gemini gemini-embedding-001 æ¨¡å‹
   - 768 ç»´å‘é‡
   - ç¼“å­˜ä¼˜åŒ–: ç›¸åŒä»£ç ä¸é‡å¤åµŒå…¥
                    â”‚
                    â–¼
4. ç›¸ä¼¼åº¦æœç´¢ (Cosine Similarity)
   - pgvector å‘é‡æ•°æ®åº“
   - è®¡ç®— Prompt ä¸æ¯ä¸ª Chunk çš„ç›¸ä¼¼åº¦
   - ç¤ºä¾‹: MapScreen=0.715, BattleScene=0.742
                    â”‚
                    â–¼
5. ğŸ†• GraphRAG ä¸Šä¸‹æ–‡æ‰©å±• (P2 ä¼˜åŒ–)
   - æ„å»ºä¾èµ–å›¾ (buildDependencyGraph)
   - å‘ä¸‹æ‰©å±•: ç›®æ ‡ä¾èµ–çš„æ¨¡å— â†’ readOnly ä¸Šä¸‹æ–‡
   - å‘ä¸Šæ‰©å±•: ä¾èµ–ç›®æ ‡çš„æ¨¡å— â†’ å¯èƒ½éœ€è¦ä¿®æ”¹
   - é™åˆ¶: maxDepth=2, maxNodes=15
```

**ğŸ†• P2 ä¼˜åŒ–: GraphRAG ä¾èµ–å›¾**

```typescript
interface DependencyGraph {
    dependencies: Map<string, string[]>;  // èŠ‚ç‚¹ â†’ ä¾èµ–åˆ—è¡¨
    dependents: Map<string, string[]>;    // èŠ‚ç‚¹ â†’ è¢«ä¾èµ–åˆ—è¡¨
    nodes: string[];
}

// æ„å»ºä¾èµ–å›¾
function buildDependencyGraph(chunks: CodeChunk[]): DependencyGraph {
    // 1. åˆ†ææ¯ä¸ª Chunk çš„ import å’Œ JSX ä½¿ç”¨
    // 2. å»ºç«‹åŒå‘ç´¢å¼•
    // 3. è¿”å›å®Œæ•´ä¾èµ–å›¾
}

// æ™ºèƒ½ä¸Šä¸‹æ–‡æ‰©å±•
function expandContextByGraph(targetIds, graph, options): { edit: string[]; read: string[] } {
    // BFS éå†ä¾èµ–å›¾
    // æ·±åº¦ 1 çš„çˆ¶èŠ‚ç‚¹ â†’ edit (å¯èƒ½éœ€è¦ä¿®æ”¹)
    // æ·±åº¦ 1 çš„å­èŠ‚ç‚¹ â†’ read (ä»…éœ€å‚è€ƒ)
    // æ·±åº¦ > 1 â†’ read
}
```

**ç¤ºä¾‹:**
```
ç›®æ ‡: MapScreen

ä¾èµ–å›¾æ‰©å±•ç»“æœ:
â”œâ”€â”€ edit (éœ€è¦ä¿®æ”¹):
â”‚   â”œâ”€â”€ MapScreen (ç›®æ ‡)
â”‚   â””â”€â”€ GameScreen (ä½¿ç”¨ MapScreen, å¯èƒ½éœ€è¦è°ƒæ•´)
â”‚
â””â”€â”€ read (ä»…å‚è€ƒ):
    â”œâ”€â”€ TILE_CLASSES (MapScreen ä¾èµ–)
    â”œâ”€â”€ VISIBILITY_RADIUS (MapScreen ä¾èµ–)
    â””â”€â”€ App (æ ¹ç»„ä»¶)
```

**ğŸ†• P3 ä¼˜åŒ–: è¯­ä¹‰å‹ç¼©é¢„å¤„ç†**

```typescript
function semanticPrecompress(code: string, options: {
    removeComments?: boolean;       // åˆ é™¤æ³¨é‡Š (ä¿ç•™ JSDoc)
    collapseBlankLines?: boolean;   // åˆå¹¶ç©ºè¡Œ
    removeConsoleLogs?: boolean;    // åˆ é™¤ console.log
    truncateLongStrings?: boolean;  // æˆªæ–­é•¿å­—ç¬¦ä¸²
    maxStringLength?: number;       // é»˜è®¤ 200
}): { code: string; stats: CompressionStats }

// ç¤ºä¾‹æ•ˆæœ:
// åŸå§‹: 12,500 å­—ç¬¦
// å‹ç¼©: 9,800 å­—ç¬¦
// èŠ‚çœ: 21.6%
```

**ğŸ†• P0 ä¼˜åŒ–: STRICT MODE (ä¿¡ä»» DeepSeek)**
```typescript
// å½“ DeepSeek æä¾›äº† files_to_edit/files_to_read æ—¶
// å®Œå…¨ä¿¡ä»» DeepSeekï¼Œç¦ç”¨åŸºäºå­—ç¬¦ä¸²çš„æ¨¡ç³ŠåŒ¹é…
// é˜²æ­¢ "screen" åŒ¹é… "LaunchScreen", "DexScreen" ç­‰å™ªéŸ³

const TRUST_DEEPSEEK_ONLY = explicitTargets.length > 0 || referenceTargets.length > 0;

if (TRUST_DEEPSEEK_ONLY) {
    // åªå…è®¸ç²¾ç¡®åŒ¹é…å®Œæ•´ç»„ä»¶å
    // ç¦ç”¨ä¸­æ–‡å…³é”®è¯æ¨¡ç³ŠåŒ¹é…
}
```

**å‡½æ•°åâ†’çˆ¶æ–‡ä»¶è§£æ** (æ–°å¢ä¿®å¤):
```typescript
// å¦‚æœ DeepSeek è¿”å›å‡½æ•°å "handleMove" è€Œä¸æ˜¯ç»„ä»¶å "MapScreen"
// ç³»ç»Ÿä¼šè‡ªåŠ¨è§£æ: handleMove â†’ å®šä¹‰åœ¨ MapScreen â†’ ä¿ç•™ MapScreen å®Œæ•´ä»£ç 
```

---

### Stage 3: Smart Compression (æ™ºèƒ½å‹ç¼©)

**æ–‡ä»¶ä½ç½®**: `lib/code-rag.ts`

**æ ¸å¿ƒå‡½æ•°**: `compressCode()` â†’ `skeletonizeCode()`

**å‹ç¼©ç­–ç•¥åˆ†å±‚**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Primary Targets (Explicit Files to Edit)              â”‚
â”‚  ç­–ç•¥: ğŸ“ FULL CODE - å®Œæ•´ä¿ç•™ï¼Œä¸åšä»»ä½•å‹ç¼©                      â”‚
â”‚  ç¤ºä¾‹: MapScreen (ç”¨æˆ·æŒ‡å®šè¦ä¿®æ”¹çš„ç»„ä»¶)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Context References (files_to_read)                    â”‚
â”‚  ç­–ç•¥: ğŸ“– AST Skeleton - ä¿ç•™å‡½æ•°ç­¾åï¼Œéšè—å‡½æ•°ä½“                 â”‚
â”‚  ç¤ºä¾‹:                                                          â”‚
â”‚    // Before:                                                   â”‚
â”‚    function BattleScene({ player, enemy }) {                    â”‚
â”‚      const [hp, setHp] = useState(100);                         â”‚
â”‚      // ... 260 lines ...                                       â”‚
â”‚      return <div>...</div>                                      â”‚
â”‚    }                                                            â”‚
â”‚    // After:                                                    â”‚
â”‚    function BattleScene({ player, enemy }) {                    â”‚
â”‚      /* Body hidden: 45 statements */                           â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ†• Layer 3: Data/Config Files (Pure Constants)                 â”‚
â”‚  ç­–ç•¥: ğŸ“Š Data Skeletonization - ä¿ç•™æ‰€æœ‰ KEYï¼Œæˆªæ–­é•¿ VALUE      â”‚
â”‚  ğŸ†• P0 ä¼˜åŒ–: ä¸å†ä½¿ç”¨ Brutal Truncateï¼                          â”‚
â”‚  ç¤ºä¾‹:                                                          â”‚
â”‚    // Before: VISIBILITY_RADIUS (131 lines)                     â”‚
â”‚    export const VISIBILITY_RADIUS = 3;                          â”‚
â”‚    export const MAP_WIDTH = 20;                                 â”‚
â”‚    export const LARGE_ARRAY = [/* 100 items */];                â”‚
â”‚                                                                 â”‚
â”‚    // After: ä¿ç•™æ‰€æœ‰å¯¼å‡ºçš„ KEY åç§°ï¼                            â”‚
â”‚    export const VISIBILITY_RADIUS = 3;                          â”‚
â”‚    export const MAP_WIDTH = 20;                                 â”‚
â”‚    export const LARGE_ARRAY = [ /* 100 items - see source */ ]; â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: Irrelevant Modules (Non-data, Non-target)             â”‚
â”‚  ç­–ç•¥: ğŸ—œï¸ Brutal Truncate - åªä¿ç•™å‰ 10-15 è¡Œ                    â”‚
â”‚  é€‚ç”¨: éæ•°æ®æ–‡ä»¶çš„ä¸ç›¸å…³ä»£ç  (å¦‚ ShopScreen åœ¨ä¿®æ”¹ MapScreen æ—¶)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ†• P0 ä¼˜åŒ–: Data Skeletonization (æ•°æ®éª¨æ¶åŒ–)**
```typescript
// æ£€æµ‹çº¯æ•°æ®æ–‡ä»¶ (åªæœ‰ const exports, æ²¡æœ‰å‡½æ•°)
// ä¿ç•™æ‰€æœ‰å¯¼å‡ºçš„å˜é‡åï¼Œåªæˆªæ–­é•¿å€¼

function dataSkeletonize(code: string, chunkId: string) {
    // 1. æ£€æµ‹: æœ‰ exportsï¼Œæ—  functions
    const isPureDataFile = /export\s+const/.test(code) && 
                          !/function\s+\w+/.test(code);
    
    // 2. éå†æ‰€æœ‰ const å£°æ˜
    // 3. çŸ­å€¼ (<300 chars) â†’ å®Œæ•´ä¿ç•™
    // 4. é•¿å€¼ (æ•°ç»„/å¯¹è±¡) â†’ ä¿ç•™ç»“æ„ + "N items truncated"
}
```

**AST Skeletonization ç®—æ³•**:
```typescript
// ä½¿ç”¨ Babel Parser è§£æ â†’ traverse â†’ æ›¿æ¢å‡½æ•°ä½“
traverse(ast, {
    "FunctionDeclaration|ArrowFunctionExpression"(path) {
        if (bodySize > 100 || statements > 3) {
            path.get("body").replaceWith(
                t.blockStatement([]) // ç©ºå‡½æ•°ä½“
            );
            // æ·»åŠ æ³¨é‡Š: /* Body hidden: 45 statements */
        }
    }
});
```

---

### ğŸ†• è‡ªé€‚åº”å‹ç¼©ç­–ç•¥ (Adaptive Compression Strategy)

é’ˆå¯¹"é¥±å’Œå¼ä¸Šä¸‹æ–‡"åœºæ™¯ï¼ˆå¦‚å¤šç»„ä»¶äº’åŠ¨ UI ä¼˜åŒ–ï¼‰ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦å…¨é‡ä¿ç•™ä»£ç ã€‚

**å†³ç­–æµç¨‹å›¾:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Adaptive Compression Strategy                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  æ–‡ä»¶å¤§å° < 500 è¡Œ?                                                  â”‚
â”‚     â”‚ YES                    â”‚ NO                                   â”‚
â”‚     â–¼                        â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“ å…¨é‡ä¿ç•™      â”‚   â”‚ ğŸ”ª Program Slicing (ç¨‹åºåˆ‡ç‰‡)            â”‚  â”‚
â”‚  â”‚ Full Code       â”‚   â”‚                                         â”‚  â”‚
â”‚  â”‚ æ— å‹ç¼©          â”‚   â”‚  1. buildDataFlowGraph() æ„å»ºæ•°æ®æµå›¾    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  2. æå–ç›®æ ‡å‡½æ•° + ä¾èµ–é“¾                â”‚  â”‚
â”‚                        â”‚  3. computeProgramSlice('backward')     â”‚  â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                           â”‚
â”‚                                         â–¼                           â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                        â”‚ åˆ‡ç‰‡å < 500 è¡Œ?                         â”‚  â”‚
â”‚                        â”‚   â”‚ YES             â”‚ NO                â”‚  â”‚
â”‚                        â”‚   â–¼                 â–¼                   â”‚  â”‚
â”‚                        â”‚ âœ… ä½¿ç”¨åˆ‡ç‰‡      ğŸ—œï¸ AST Skeleton        â”‚  â”‚
â”‚                        â”‚   (ç²¾ç¡®ä¸Šä¸‹æ–‡)     (ä¿ç•™ç­¾å+æ³¨é‡Š)       â”‚  â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é€‚ç”¨åœºæ™¯å¯¹æ¯”:**

| åœºæ™¯ | å‹ç¼©ç­–ç•¥ | åŸå›  |
|------|----------|------|
| ä¿®å¤å•ä¸ª Bug | Program Slicing | åªéœ€çœ‹ç›¸å…³æ•°æ®æµ |
| æ”¹æŒ‰é’®é¢œè‰² | æ¿€è¿›å‹ç¼© (8è¡Œ) | åªéœ€çœ‹æ ·å¼å®šä¹‰ |
| **å¤šç»„ä»¶äº’åŠ¨ UI** | **å…¨é‡ä¿ç•™** | éœ€è¦çœ‹ç»„ä»¶é—´é€šä¿¡ |
| å¤§æ–‡ä»¶ (>500è¡Œ) | Slicing â†’ Skeleton | é˜²æ­¢ Token çˆ†ç‚¸ |

**ä»£ç å®ç°:**
```typescript
function selectCompressionStrategy(
    chunk: CodeChunk, 
    intent: UserIntent,
    isMultiComponentInteraction: boolean
): CompressionLevel {
    const lineCount = chunk.content.split('\n').length;
    
    // åœºæ™¯ 1: å¤šç»„ä»¶äº’åŠ¨ (å¦‚ UI ä¼˜åŒ–) â†’ é¥±å’Œå¼ä¿ç•™
    if (isMultiComponentInteraction && lineCount < 500) {
        console.log(`[Compression] ğŸ“ Full code for ${chunk.id} (multi-component interaction)`);
        return 'FULL';
    }
    
    // åœºæ™¯ 2: å°æ–‡ä»¶ â†’ ç›´æ¥å…¨é‡ä¿ç•™
    if (lineCount < 500) {
        return 'FULL';
    }
    
    // åœºæ™¯ 3: å¤§æ–‡ä»¶ â†’ å°è¯• Program Slicing
    const slice = computeProgramSlice(chunk.content, targetFunction, 'backward');
    if (slice && slice.code.split('\n').length < 500) {
        console.log(`[Compression] ğŸ”ª Sliced ${chunk.id}: ${lineCount} â†’ ${slice.code.split('\n').length} lines`);
        return 'SLICED';
    }
    
    // åœºæ™¯ 4: åˆ‡ç‰‡åä»ç„¶å¤ªå¤§ â†’ AST Skeleton
    console.log(`[Compression] ğŸ¦´ Skeleton for ${chunk.id} (${lineCount} lines too large)`);
    return 'SKELETON';
}
```

**æ•ˆæœç¤ºä¾‹:**
```
åŸå§‹ App.js: 2000 è¡Œ
â”œâ”€â”€ ç›®æ ‡å‡½æ•°: handleAnswer
â”œâ”€â”€ Backward Slice: æå–ç›¸å…³ä»£ç  150 è¡Œ
â”œâ”€â”€ å‹ç¼©æ¯”: 92.5%
â””â”€â”€ ä¿ç•™: handleAnswer + ä¾èµ–çš„ state/constants
```

**æ—¥å¿—è¯†åˆ«:**
```
[Compression] ğŸ“ Full code for QuestionCard (multi-component interaction)
[Compression] ğŸ“ Full code for ProgressBar (multi-component interaction)
[Compression] ğŸ”ª Sliced App: 2000 â†’ 150 lines
```

---

## ğŸš€ é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾ (Advanced Optimization Roadmap)

> å½“å‰ç“¶é¢ˆï¼š**Stage 3 (Smart Compression)** å’Œ **Stage 4 (LLM Generation)** ä¹‹é—´çš„ Token æ¶ˆè€—ã€‚
> 
> ç›®æ ‡ï¼šåœ¨**ä¸é™ä½è´¨é‡**çš„å‰æä¸‹ï¼Œå¤§å¹…å‡å°‘ Token æ¶ˆè€—ã€‚

### ä¼˜åŒ–å…¨æ™¯è¡¨

| ä¼˜å…ˆçº§ | ä¼˜åŒ–æ‰‹æ®µ | éš¾åº¦ | Token èŠ‚çœæ½œåŠ› | æ ¸å¿ƒä»·å€¼ | çŠ¶æ€ |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **P0** | **Prompt Caching (APIçº§)** | ä½ | **90% cost** | å‡ ä¹é›¶æˆæœ¬å®ç°å·¨å¤§æˆæœ¬/é€Ÿåº¦ä¼˜åŒ– | âœ… å·²å®ç° |
| **P1** | **Type Definitions (.d.ts)** | ä¸­ | 30% | é’ˆå¯¹å‚è€ƒæ–‡ä»¶çš„æå¤§å‹ç¼©ï¼Œä¿ç•™æ ¸å¿ƒè¯­ä¹‰ | âœ… å·²å®ç° |
| **P2** | **Program Slicing (åˆ‡ç‰‡)** | é«˜ | **50%+** | çœŸæ­£çš„"æ™ºèƒ½"ä¸Šä¸‹æ–‡ï¼Œå»é™¤æ‰€æœ‰å™ªéŸ³ | âœ… å·²å®ç° |
| **P3** | **GraphRAG Pruning** | ä¸­ | 15-25% | é˜²æ­¢å¤æ‚é¡¹ç›®ä¸­çš„ä¸Šä¸‹æ–‡çˆ†ç‚¸ | âœ… å·²å®ç° |
| **P4** | **Unified Diff è¾“å‡º** | ä½ | 30% output | å‡å°‘è¾“å‡º Tokenï¼Œæå‡ç”Ÿæˆé€Ÿåº¦ | âœ… å·²å®ç° |

---

### P0: Prompt Caching (APIçº§ç¼“å­˜) âš¡ âœ… å·²å®ç°

> **å®ç°æ–‡ä»¶**: [lib/prompt-cache.ts](../lib/prompt-cache.ts)
> 
> å®ç°äº†ä¸‰çº§ç¼“å­˜ç³»ç»Ÿï¼šL1 ç³»ç»Ÿæç¤ºè¯ç¼“å­˜ã€L2 é¡¹ç›®éª¨æ¶ç¼“å­˜ã€L3 ä¼šè¯ä¸Šä¸‹æ–‡ç¼“å­˜

**ç°çŠ¶é—®é¢˜**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½å‘é€å®Œæ•´çš„ System Promptã€é¡¹ç›®ç»“æ„ç­‰é‡å¤å†…å®¹ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šåˆ©ç”¨ LLM æä¾›å•†ï¼ˆDeepSeek V3, Gemini 1.5, Anthropicï¼‰çš„ **Context Caching** åŠŸèƒ½ã€‚

**åˆ†å±‚ Prompt æ¶æ„:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layered Prompt Architecture                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Layer 1: Static (ç¼“å­˜ TTL: é•¿, å¦‚ 1 å°æ—¶)                           â”‚
â”‚  â”œâ”€â”€ System Prompt (è§’è‰²å®šä¹‰ã€è¾“å‡ºæ ¼å¼è§„èŒƒ)                           â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒé¡¹ç›®è§„èŒƒ (ç¼–ç é£æ ¼ã€å‘½åçº¦å®š)                                 â”‚
â”‚  â””â”€â”€ å¸¸ç”¨å·¥å…·åº“å®šä¹‰ (React hooks, é€šç”¨ç±»å‹)                          â”‚
â”‚                                                                     â”‚
â”‚  Layer 2: Project Structure (ç¼“å­˜ TTL: ä¸­ç­‰, å¦‚ 10 åˆ†é’Ÿ)             â”‚
â”‚  â”œâ”€â”€ å®Œæ•´æ–‡ä»¶æ ‘ (ç›®å½•ç»“æ„)                                           â”‚
â”‚  â”œâ”€â”€ ç»„ä»¶ä¾èµ–å›¾æ‘˜è¦                                                  â”‚
â”‚  â””â”€â”€ å…¨å±€ç±»å‹å®šä¹‰ (types/*.ts)                                      â”‚
â”‚                                                                     â”‚
â”‚  Layer 3: Dynamic (ä¸ç¼“å­˜, æ¯æ¬¡è¯·æ±‚åŠ¨æ€ç”Ÿæˆ)                          â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·çš„å…·ä½“è¯·æ±‚                                                  â”‚
â”‚  â”œâ”€â”€ RAG æ£€ç´¢åˆ°çš„ä»£ç ç‰‡æ®µ                                            â”‚
â”‚  â””â”€â”€ å½“å‰æ–‡ä»¶çš„å‹ç¼©ä¸Šä¸‹æ–‡                                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ–¹å¼:**
```typescript
// ä½¿ç”¨ Gemini Context Caching API
const cachedContent = await cacheManager.createCachedContent({
    model: 'gemini-1.5-pro',
    displayName: 'spark-vertex-system-prompt',
    contents: [
        { role: 'user', parts: [{ text: SYSTEM_PROMPT }] },
        { role: 'user', parts: [{ text: PROJECT_STRUCTURE }] }
    ],
    ttl: '3600s' // 1 å°æ—¶
});

// åç»­è¯·æ±‚å¤ç”¨ç¼“å­˜
const response = await model.generateContent({
    cachedContent: cachedContent.name,
    contents: [dynamicUserRequest]
});
```

**é¢„æœŸæ”¶ç›Š:**
- ğŸ’° è®¡è´¹ Token å‡å°‘ **70% - 90%**
- âš¡ é¦–å­—å»¶è¿Ÿ (TTFT) å¤§å¹…é™ä½
- ğŸ”„ æ— éœ€æ”¹åŠ¨ç°æœ‰é€»è¾‘

---

### P1: Type Definitions (.d.ts) ä»£æ›¿ä»£ç éª¨æ¶ ğŸ“ âœ… å·²å®ç°

> **å®ç°æ–‡ä»¶**: [lib/advanced-rag.ts](../lib/advanced-rag.ts) - `generateTypeDefinition()` å‡½æ•°
> 
> **é›†æˆä½ç½®**: [lib/code-rag.ts](../lib/code-rag.ts) - `applyTrustModeCompression()` å‡½æ•°
> 
> å¯¹å‚è€ƒæ–‡ä»¶ (files_to_read) è‡ªåŠ¨ç”Ÿæˆç±»å‹å®šä¹‰ï¼ŒèŠ‚çœ 30-50% Token

**ç°çŠ¶é—®é¢˜**ï¼šå¯¹äº Reference Targetsï¼ˆå‚è€ƒæ–‡ä»¶ï¼‰ï¼Œç›®å‰ä¿ç•™å‡½æ•°å¤´å’Œç©ºå‡½æ•°ä½“ï¼Œä»å ç”¨è¾ƒå¤š Tokenã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šå¯¹äºéç¼–è¾‘ç›®æ ‡ï¼ˆåªè¯»æ–‡ä»¶ï¼‰ï¼Œç”Ÿæˆ **TypeScript å£°æ˜æ–‡ä»¶é£æ ¼çš„ç±»å‹æ‘˜è¦**ã€‚

**å¯¹æ¯”ç¤ºä¾‹:**
```typescript
// âŒ å½“å‰: AST Skeleton (120 tokens)
function BattleScene({ player, enemy }: { player: Player; enemy: Enemy }) {
    /* Body hidden: 45 statements */
}

// âœ… ä¼˜åŒ–å: Type Definition (35 tokens)
declare function BattleScene(props: { player: Player; enemy: Enemy }): JSX.Element;

// âŒ å½“å‰: React ç»„ä»¶éª¨æ¶ (80 tokens)
const GameContext = createContext<GameState | null>(null);
export function GameProvider({ children }: { children: React.ReactNode }) {
    /* Body hidden: 12 statements */
}

// âœ… ä¼˜åŒ–å: ç±»å‹å®šä¹‰ (25 tokens)
declare const GameContext: React.Context<GameState | null>;
declare function GameProvider(props: { children: React.ReactNode }): JSX.Element;
```

**ç”Ÿæˆè§„åˆ™:**
```typescript
function generateTypeDefinition(chunk: CodeChunk): string {
    const ast = parse(chunk.content, BABEL_PARSER_CONFIG);
    const declarations: string[] = [];
    
    traverse(ast, {
        FunctionDeclaration(path) {
            const name = path.node.id?.name;
            const params = extractParamTypes(path.node.params);
            const returnType = inferReturnType(path.node);
            declarations.push(`declare function ${name}(${params}): ${returnType};`);
        },
        
        VariableDeclaration(path) {
            for (const decl of path.node.declarations) {
                if (t.isIdentifier(decl.id)) {
                    const type = inferType(decl.init);
                    declarations.push(`declare const ${decl.id.name}: ${type};`);
                }
            }
        },
        
        // React ç»„ä»¶ Props ç‰¹æ®Šå¤„ç†
        TSInterfaceDeclaration(path) {
            // ä¿ç•™å®Œæ•´çš„ interface å®šä¹‰
            declarations.push(generate(path.node).code);
        }
    });
    
    return declarations.join('\n');
}
```

**é¢„æœŸæ”¶ç›Š:**
- ğŸ“‰ Token å‡å°‘ **30%**
- ğŸ§  ä¿ç•™è¶³å¤Ÿçš„è¯­ä¹‰ä¿¡æ¯ä¾› LLM æ¨ç†
- âœ… ç±»å‹å®‰å…¨ï¼Œä¸æ˜“å‡ºé”™

---

### P2: Program Slicing (è¯­ä¹‰åˆ‡ç‰‡) ğŸ”ª

> âœ… **å·²åœ¨ `lib/advanced-rag.ts` ä¸­å®ç°**

**ç°çŠ¶é—®é¢˜**ï¼šAST éª¨æ¶åŒ–ä¿ç•™æ–‡ä»¶ç»“æ„ï¼Œä½†å¦‚æœä¸€ä¸ªæ–‡ä»¶æœ‰ 50 ä¸ªå‡½æ•°ï¼Œåªæ”¹å…¶ä¸­ 1 ä¸ªï¼Œå¦å¤– 49 ä¸ªå‡½æ•°çš„"ç©ºå£³"ä¾ç„¶å ç”¨ Tokenã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåŸºäº **æ•°æ®æµ (Data Flow)** å’Œ **æ§åˆ¶æµ (Control Flow)** åˆ†æçš„é™æ€ç¨‹åºåˆ‡ç‰‡ã€‚

**å·¥ä½œåŸç†:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Program Slicing Pipeline                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  è¾“å…¥: ç›®æ ‡å˜é‡ `userBalance`                                        â”‚
â”‚                     â”‚                                               â”‚
â”‚                     â–¼                                               â”‚
â”‚  1. æ„å»ºæ•°æ®æµå›¾ (buildDataFlowGraph)                                â”‚
â”‚     â”œâ”€â”€ å˜é‡å®šä¹‰ä½ç½®                                                 â”‚
â”‚     â”œâ”€â”€ å˜é‡ä½¿ç”¨ä½ç½®                                                 â”‚
â”‚     â””â”€â”€ å˜é‡é—´ä¾èµ–å…³ç³»                                               â”‚
â”‚                     â”‚                                               â”‚
â”‚                     â–¼                                               â”‚
â”‚  2. è®¡ç®— Backward Slice                                             â”‚
â”‚     â””â”€â”€ æ‰€æœ‰ **å½±å“** `userBalance` çš„è¯­å¥                           â”‚
â”‚         â”œâ”€â”€ initialBalance (å¸¸é‡)                                   â”‚
â”‚         â”œâ”€â”€ calculateBonus() (å‡½æ•°è°ƒç”¨)                              â”‚
â”‚         â””â”€â”€ user.rewards (å±æ€§è®¿é—®)                                  â”‚
â”‚                     â”‚                                               â”‚
â”‚                     â–¼                                               â”‚
â”‚  3. è®¡ç®— Forward Slice                                              â”‚
â”‚     â””â”€â”€ æ‰€æœ‰ **è¢« `userBalance` å½±å“** çš„è¯­å¥                        â”‚
â”‚         â”œâ”€â”€ displayBalance() (UI æ¸²æŸ“)                              â”‚
â”‚         â”œâ”€â”€ canPurchase() (é€»è¾‘åˆ¤æ–­)                                 â”‚
â”‚         â””â”€â”€ saveToStorage() (å‰¯ä½œç”¨)                                â”‚
â”‚                     â”‚                                               â”‚
â”‚                     â–¼                                               â”‚
â”‚  4. åˆå¹¶åˆ‡ç‰‡ + æ·»åŠ ä¸Šä¸‹æ–‡è¡Œ                                           â”‚
â”‚     â””â”€â”€ è¾“å‡º: ç²¾ç¡®çš„ä»£ç ç‰‡æ®µ (åŸå§‹ 2000 è¡Œ â†’ 150 è¡Œ)                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ AST Skeleton çš„å¯¹æ¯”:**
```
åŸå§‹æ–‡ä»¶: PaymentService.ts (2000 è¡Œ, 50 ä¸ªå‡½æ•°)
ç›®æ ‡: ä¿®æ”¹ calculateDiscount()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–¹æ¡ˆ                    â”‚ ä¿ç•™å†…å®¹                    â”‚ Token æ•°   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Full Code              â”‚ å…¨éƒ¨ 2000 è¡Œ                â”‚ ~8000      â”‚
â”‚  AST Skeleton           â”‚ 50 ä¸ªå‡½æ•°ç­¾å + ç©ºå‡½æ•°ä½“     â”‚ ~2500      â”‚
â”‚  ğŸ†• Program Slicing     â”‚ ä»… 3 ä¸ªç›¸å…³å‡½æ•° + ä¾èµ–       â”‚ ~800       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Token èŠ‚çœ: 68% (vs Skeleton), 90% (vs Full)
```

**é¢„æœŸæ”¶ç›Š:**
- ğŸ“‰ Token å‡å°‘ **40% - 60%**
- ğŸ¯ "æ‰‹æœ¯åˆ€"çº§åˆ«çš„ç²¾å‡†ä¸Šä¸‹æ–‡
- ğŸ§  å‡å°‘å™ªéŸ³ï¼Œæå‡ LLM èšç„¦åº¦

---

### P3: GraphRAG Pruning (ä¾èµ–å›¾å‰ªæ) âœ‚ï¸ âœ… å·²å®ç°

> **å®ç°æ–‡ä»¶**: [lib/advanced-rag.ts](../lib/advanced-rag.ts) - `computePageRank()`, `pruneGraphByPageRank()`
> 
> **é›†æˆä½ç½®**: [lib/code-rag.ts](../lib/code-rag.ts) - GraphRAG æ‰©å±•æµç¨‹ä¸­è‡ªåŠ¨å¯ç”¨
> 
> å¯¹è¶…è¿‡ 15 ä¸ªèŠ‚ç‚¹çš„ä¾èµ–å›¾è‡ªåŠ¨è¿›è¡Œ PageRank å‰ªæ

**ç°çŠ¶é—®é¢˜**ï¼šGraphRAG åš"ä¸Šä¸‹æ–‡æ‰©å±•"æ—¶ï¼Œå¯èƒ½å¼•å…¥è¿‡å¤šå™ªéŸ³ï¼ˆä¸æ˜¯æ‰€æœ‰ä¾èµ–éƒ½åŒç­‰é‡è¦ï¼‰ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šå¼•å…¥ **PageRank / ä¸­å¿ƒåº¦ç®—æ³•** è¿›è¡Œå‰ªæã€‚

**å‰ªæç­–ç•¥:**
```typescript
interface PruningConfig {
    maxDistance: number;        // æœ€å¤§ä¾èµ–è·ç¦» (é»˜è®¤ 2)
    minRelevanceScore: number;  // æœ€å°ç›¸å…³æ€§é˜ˆå€¼ (é»˜è®¤ 0.3)
    maxNodes: number;           // æœ€å¤§èŠ‚ç‚¹æ•° (é»˜è®¤ 15)
}

function pruneGraphRAG(
    graph: DependencyGraph,
    targetIds: string[],
    config: PruningConfig
): DependencyGraph {
    const relevanceScores = new Map<string, number>();
    
    // 1. è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹ä¸ç›®æ ‡çš„è¯­ä¹‰è·ç¦»
    for (const nodeId of graph.nodes) {
        const distance = calculateGraphDistance(targetIds, nodeId, graph);
        const referenceCount = countReferences(nodeId, graph);
        
        // PageRank é£æ ¼çš„è¯„åˆ†
        relevanceScores.set(nodeId, 
            (1 / (distance + 1)) * Math.log(referenceCount + 1)
        );
    }
    
    // 2. åŒºåˆ†å¼ºå¼±ä¾èµ–
    const strongDeps = new Set<string>();  // import è¯­å¥
    const weakDeps = new Set<string>();    // useRef å†…éƒ¨å¼•ç”¨ç­‰
    
    for (const [nodeId, deps] of graph.dependencies) {
        for (const dep of deps) {
            if (isImportDependency(nodeId, dep)) {
                strongDeps.add(dep);
            } else {
                weakDeps.add(dep);
            }
        }
    }
    
    // 3. å‰ªæ: ä½ç›¸å…³æ€§ + å¼±ä¾èµ– â†’ ä¸¢å¼ƒæˆ–åªä¿ç•™åç§°
    const prunedNodes = graph.nodes.filter(nodeId => {
        const score = relevanceScores.get(nodeId) || 0;
        
        // å¼ºä¾èµ–: ä¿ç•™
        if (strongDeps.has(nodeId)) return true;
        
        // ç›®æ ‡èŠ‚ç‚¹: ä¿ç•™
        if (targetIds.includes(nodeId)) return true;
        
        // ä½ç›¸å…³æ€§å¼±ä¾èµ–: å‰ªæ
        if (score < config.minRelevanceScore && weakDeps.has(nodeId)) {
            console.log(`[GraphRAG] âœ‚ï¸ Pruned: ${nodeId} (score: ${score.toFixed(2)})`);
            return false;
        }
        
        return true;
    });
    
    return { ...graph, nodes: prunedNodes };
}
```

**æ—¥å¿—ç¤ºä¾‹:**
```
[GraphRAG] ğŸ“Š åŸå§‹ä¾èµ–å›¾: 25 èŠ‚ç‚¹
[GraphRAG] âœ‚ï¸ Pruned: DebugUtils (score: 0.12)
[GraphRAG] âœ‚ï¸ Pruned: TestHelpers (score: 0.08)
[GraphRAG] âœ‚ï¸ Pruned: OldMigrations (score: 0.05)
[GraphRAG] ğŸ“Š å‰ªæå: 18 èŠ‚ç‚¹ (å‡å°‘ 28%)
```

**é¢„æœŸæ”¶ç›Š:**
- ğŸ“‰ é˜²æ­¢ä¸Šä¸‹æ–‡éšä¾èµ–æ·±åº¦æŒ‡æ•°çº§è†¨èƒ€
- ğŸ¯ ä¿ç•™é«˜ç›¸å…³æ€§ä¾èµ–
- ğŸ§¹ å»é™¤è°ƒè¯•å·¥å…·ã€æµ‹è¯•è¾…åŠ©ç­‰å™ªéŸ³

---

### P4: Unified Diff è¾“å‡ºæ ¼å¼ (å¯é€‰) ğŸ“„ âœ… å·²å®ç°

> **å®ç°æ–‡ä»¶**: [lib/advanced-rag.ts](../lib/advanced-rag.ts) - `generateUnifiedDiff()`, `applyUnifiedDiff()`
> 
> **å¯¼å‡ºä½ç½®**: [lib/code-rag.ts](../lib/code-rag.ts) - å¯¼å‡ºä¾›å¤–éƒ¨ä½¿ç”¨
> 
> æä¾›å®Œæ•´çš„ Unified Diff ç”Ÿæˆå’Œåº”ç”¨åŠŸèƒ½

**ç°çŠ¶é—®é¢˜**ï¼š`SEARCH/REPLACE` æ ¼å¼éœ€è¦åœ¨ SEARCH å—ä¸­é‡å¤æ—§ä»£ç ï¼Œå¢åŠ è¾“å‡º Tokenã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šå¯¹äºç®€å•ä¿®æ”¹ï¼Œæ”¯æŒ **Unified Diff** æ ¼å¼ã€‚

**æ ¼å¼å¯¹æ¯”:**
```diff
# âŒ å½“å‰: SEARCH/REPLACE (60 output tokens)
<<<<SEARCH
const theme = {
    primary: '#3B82F6',
    secondary: '#10B981',
    background: '#F3F4F6'
};
====
const theme = {
    primary: '#EF4444',    // æ”¹ä¸ºçº¢è‰²
    secondary: '#10B981',
    background: '#F3F4F6'
};
>>>>

# âœ… ä¼˜åŒ–å: Unified Diff (25 output tokens)
@@ -1,5 +1,5 @@
 const theme = {
-    primary: '#3B82F6',
+    primary: '#EF4444',    // æ”¹ä¸ºçº¢è‰²
     secondary: '#10B981',
     background: '#F3F4F6'
 };
```

**æ··åˆæ¨¡å¼ç­–ç•¥:**
```typescript
type PatchFormat = 'search-replace' | 'unified-diff';

function selectPatchFormat(modification: Modification): PatchFormat {
    // å¤§æ®µé‡æ„: ä¿æŒ SEARCH/REPLACE (ç¨³å¥)
    if (modification.linesChanged > 10) {
        return 'search-replace';
    }
    
    // å¤šå¤„åˆ†æ•£ä¿®æ”¹: ä¿æŒ SEARCH/REPLACE
    if (modification.locations > 3) {
        return 'search-replace';
    }
    
    // å°ä¿®è¡¥ (æ”¹é…ç½®ã€æ”¹ä¸€è¡Œ): ä½¿ç”¨ Unified Diff
    if (modification.linesChanged <= 3 && modification.isSimpleChange) {
        return 'unified-diff';
    }
    
    return 'search-replace'; // é»˜è®¤ç¨³å¥æ¨¡å¼
}
```

**é£é™©ä¸å¯¹ç­–:**
- âš ï¸ **LLM å®¹æ˜“ç®—é”™è¡Œå·** â†’ ä½¿ç”¨å†…å®¹é”šç‚¹éªŒè¯ + è‡ªåŠ¨ä¿®æ­£
- âš ï¸ **æ ¼å¼åˆ‡æ¢å¢åŠ å¤æ‚åº¦** â†’ å…ˆåœ¨ä½é£é™©åœºæ™¯è¯•ç‚¹

**é¢„æœŸæ”¶ç›Š:**
- ğŸ“‰ è¾“å‡º Token å‡å°‘ **30%**
- âš¡ é—´æ¥æå‡ç”Ÿæˆé€Ÿåº¦
- ğŸ”§ é€‚ç”¨äºé…ç½®ä¿®æ”¹ã€æ ·å¼è°ƒæ•´ç­‰ç®€å•åœºæ™¯

---

### å®æ–½è·¯çº¿å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Implementation Timeline                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Phase 1 (Quick Wins) - 1-2 å‘¨                                      â”‚
â”‚  â”œâ”€â”€ âœ… P2: Program Slicing (å·²å®Œæˆ)                                â”‚
â”‚  â”œâ”€â”€ ğŸ”œ P0: Prompt Caching é›†æˆ                                     â”‚
â”‚  â”‚   â””â”€â”€ æ¥å…¥ Gemini/DeepSeek Context Cache API                    â”‚
â”‚  â””â”€â”€ ğŸ”œ P1: Type Definitions ç”Ÿæˆå™¨                                 â”‚
â”‚      â””â”€â”€ æ–°å¢ generateTypeDefinition() å‡½æ•°                         â”‚
â”‚                                                                     â”‚
â”‚  Phase 2 (Deep Optimization) - 3-4 å‘¨                               â”‚
â”‚  â”œâ”€â”€ ğŸ”œ P3: GraphRAG Pruning                                        â”‚
â”‚  â”‚   â””â”€â”€ é›†æˆ PageRank è¯„åˆ† + å‰ªæé€»è¾‘                               â”‚
â”‚  â””â”€â”€ ğŸ”œ P4: Unified Diff æ”¯æŒ (å¯é€‰)                                â”‚
â”‚      â””â”€â”€ æ–°å¢ diff è§£æå™¨ + æ··åˆæ¨¡å¼é€‰æ‹©                             â”‚
â”‚                                                                     â”‚
â”‚  é¢„æœŸç»¼åˆæ•ˆæœ:                                                       â”‚
â”‚  â”œâ”€â”€ Token æ¶ˆè€—: -60% ~ -80%                                        â”‚
â”‚  â”œâ”€â”€ API æˆæœ¬: -70% ~ -90% (Prompt Caching)                        â”‚
â”‚  â””â”€â”€ å“åº”é€Ÿåº¦: +30% ~ +50%                                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Stage 4: LLM Generation (ä»£ç ç”Ÿæˆ)

**è¾“å…¥æ„å»º**:
```
System Prompt (lib/prompts.ts):
â”œâ”€â”€ è§’è‰²å®šä¹‰: Expert React Developer
â”œâ”€â”€ è¾“å‡ºæ ¼å¼: <<<<SEARCH ... ==== REPLACE ... >>>>
â”œâ”€â”€ è§„åˆ™:
â”‚   â”œâ”€â”€ ä¸è¦å‡è®¾ä»£ç å­˜åœ¨ï¼Œä½¿ç”¨æä¾›çš„ä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ æ¯ä¸ª Patch å—è¦åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ ä¸è¦æ·»åŠ ä¸å­˜åœ¨çš„æ³¨é‡Š

User Prompt:
â”œâ”€â”€ compressedCode (å‹ç¼©åçš„å®Œæ•´ä»£ç )
â”œâ”€â”€ ragContext (RAG é€‰ä¸­çš„ä»£ç ç‰‡æ®µ)
â”œâ”€â”€ codeContext (ä¼˜åŒ–æç¤º)
â””â”€â”€ ç”¨æˆ·åŸå§‹è¯·æ±‚
```

**è¾“å‡ºæ ¼å¼**:
```diff
<<<<SEARCH
const MapScreen = ({ player, onMove }) => {
    const [position, setPosition] = useState({ x: 5, y: 5 });
====
const MapScreen = ({ player, onMove }) => {
    const [position, setPosition] = useState({ x: 5, y: 5 });
    const [fogOfWar, setFogOfWar] = useState(true); // æ–°å¢
>>>>
```

---

## Patch ç³»ç»Ÿå®Œæ•´é“¾è·¯

### ğŸ¯ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LLM è¾“å‡ºçš„ Patch æ–‡æœ¬                                  â”‚
â”‚  <<<<SEARCH @L42-L58 ... ==== REPLACE ... >>>>  æˆ–  <<<<AST_REPLACE: Name>>>>   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 0: Patch æ ¼å¼æ£€æµ‹                                                          â”‚
â”‚  â”œâ”€â”€ AST_REPLACE æ ¼å¼ â†’ èµ° Explicit AST è·¯å¾„                                    â”‚
â”‚  â”œâ”€â”€ @L[start]-L[end] è¡Œå·é”šå®š â†’ èµ° Line Anchored è·¯å¾„ ğŸ†•                        â”‚
â”‚  â””â”€â”€ SEARCH/REPLACE æ ¼å¼ â†’ èµ° Token Matching è·¯å¾„                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                    â–¼                      â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ Explicit AST Replaceâ”‚  â”‚ ğŸ†• Line Anchored    â”‚  â”‚  Token-based Matching       â”‚â”‚
â”‚ (Scheme 2: Modular) â”‚  â”‚  (P1 ä¼˜åŒ–)           â”‚  â”‚  (Scheme 1: Cursor-style)   â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
              â”‚                    â”‚                      â”‚                       â”‚
              â–¼                    â–¼                      â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚applyExplicitASTPatchâ”‚  â”‚applyLineAnchoredPatchâ”‚ â”‚  applyPatchesInternal()     â”‚â”‚
â”‚ ç›´æ¥å®šä½å˜é‡/å‡½æ•°å   â”‚  â”‚ è¡Œå·èŒƒå›´ + ç›¸ä¼¼åº¦éªŒè¯ â”‚  â”‚  å¤šç­–ç•¥åŒ¹é… (è§ä¸‹æ–¹è¯¦è§£)      â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                                         â”‚                                        â”‚
                                         â–¼                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Post-Validation (å®‰å…¨æ ¡éªŒ)                                                      â”‚
â”‚  â”œâ”€â”€ é•¿åº¦æ£€æŸ¥: ç»“æœä¸èƒ½å¤ªçŸ­ (<50% åŸå§‹) æˆ–å¤ªé•¿ (>300%)                            â”‚
â”‚  â”œâ”€â”€ è¯­æ³•ä¿®å¤: validateAndFixSyntax() - ä¿®å¤å¸¸è§è¯­æ³•é”™è¯¯                         â”‚
â”‚  â”œâ”€â”€ å®šä¹‰å»é‡: dedupeTopLevelBindings() - åˆ é™¤é‡å¤çš„å˜é‡/å‡½æ•°å®šä¹‰                 â”‚
â”‚  â”œâ”€â”€ å¼•ç”¨æ£€æµ‹: detectUndefinedReferences() - æ£€æµ‹åˆ é™¤äº†ä½†ä»è¢«å¼•ç”¨çš„ç»„ä»¶            â”‚
â”‚  â””â”€â”€ å›æ»šæœºåˆ¶: ä»»ä½•æ ¡éªŒå¤±è´¥ â†’ è¿”å›åŸå§‹ä»£ç                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ†• P1 ä¼˜åŒ–: è¡Œå·é”šå®šåŒ¹é… (Line Anchored Matching)

**è¡¥ä¸æ ¼å¼:**
```
<<<< SEARCH @L42-L58        â† è¡Œå·é”šå®šæ ‡è®°
const gridColor = "blue";   â† åŸå§‹ä»£ç  (ç”¨äºéªŒè¯)
====
const gridColor = "red";    â† æ–°ä»£ç 
>>>>
```

**å·¥ä½œåŸç†:**
```typescript
// è§£æè¡Œå·èŒƒå›´
const extractLineNumbers = (fullMatch: string): { startLine?: number; endLine?: number } => {
    const lineMatch = fullMatch.match(/@L(\d+)(?:-L(\d+))?/);
    if (lineMatch) {
        return {
            startLine: parseInt(lineMatch[1], 10),  // å¼€å§‹è¡Œ (1-based)
            endLine: lineMatch[2] ? parseInt(lineMatch[2], 10) : undefined
        };
    }
    return {};
};

// è¡Œå·é”šå®šåŒ¹é…
const applyLineAnchoredPatch = (source, searchBlock, replaceBlock, lineInfo) => {
    if (!lineInfo.startLine) return null;
    
    const sourceLines = source.split('\n');
    const searchLines = searchBlock.trim().split('\n');
    
    // è¡Œå· 1-based â†’ 0-based
    const startIdx = lineInfo.startLine - 1;
    const endIdx = lineInfo.endLine ? lineInfo.endLine - 1 : startIdx + searchLines.length - 1;
    
    // è¾¹ç•Œæ£€æŸ¥
    if (startIdx < 0 || endIdx >= sourceLines.length) return null;
    
    // éªŒè¯å†…å®¹ç›¸ä¼¼åº¦ (â‰¥70%)
    const targetContent = sourceLines.slice(startIdx, endIdx + 1).join('\n').trim();
    const similarity = calculateLineSimilarity(targetContent, searchBlock.trim());
    
    if (similarity >= 0.7) {
        // âœ… æ¥å—å®šä½ï¼Œæ‰§è¡Œæ›¿æ¢
        const before = sourceLines.slice(0, startIdx);
        const after = sourceLines.slice(endIdx + 1);
        return [...before, replaceBlock.trim(), ...after].join('\n');
    }
    
    return null; // å›é€€åˆ°å…¶ä»–ç­–ç•¥
};
```

**ä¼˜å…ˆçº§:** è¡Œå·é”šå®š > AST Smart Patch > Token åŒ¹é… > æ–‡æœ¬å›é€€

---

### Token Matching å¤šç­–ç•¥ç€‘å¸ƒ (æ ¸å¿ƒç®—æ³•)

**æ–‡ä»¶ä½ç½®**: `lib/patch.ts`

**æ ¸å¿ƒå‡½æ•°**: `applyPatchesInternal()`

**ğŸ†• Token Normalization (P2 ä¼˜åŒ–)**

åœ¨æ‰€æœ‰ Token åŒ¹é…ç­–ç•¥æ‰§è¡Œå‰ï¼Œé¦–å…ˆå¯¹ Token è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œæ¶ˆé™¤å› å¼•å·é£æ ¼ã€å¯é€‰åˆ†å·ç­‰å¯¼è‡´çš„è™šå‡ä¸åŒ¹é…ï¼š

```typescript
/**
 * Token Normalization Rules:
 * 1. å¼•å·å½’ä¸€åŒ–: " â†’ ', ` â†’ '  (åŒå¼•å·/æ¨¡æ¿å­—ç¬¦ä¸² ç»Ÿä¸€ä¸º å•å¼•å·)
 * 2. åˆ†å·å½’ä¸€åŒ–: åœ¨ JS/TS ä¸­åˆ†å·æ˜¯å¯é€‰çš„ï¼Œä¸åº”å¯¼è‡´åŒ¹é…å¤±è´¥
 * 
 * ç¤ºä¾‹åœºæ™¯:
 * - AI è¾“å‡º: const name = "value"
 * - æºç :   const name = 'value'
 * - å½’ä¸€åŒ–å: ä¸¤è€… Token åºåˆ—ç›¸åŒï¼ŒåŒ¹é…æˆåŠŸ
 */

interface Token {
    text: string;      // åŸå§‹æ–‡æœ¬
    normalized: string; // ğŸ†• å½’ä¸€åŒ–åæ–‡æœ¬
    start: number;
    end: number;
}

function normalizeToken(text: string): string {
    // Rule 1: å¼•å·å½’ä¸€åŒ–
    if (text === '"' || text === '`') return "'";
    return text;
}

// æ¯”è¾ƒå‡½æ•°ä¼˜å…ˆä½¿ç”¨å½’ä¸€åŒ–åçš„å€¼
function tokensEqual(a: Token, b: Token): boolean {
    if (a.text === b.text) return true; // å¿«é€Ÿè·¯å¾„
    return a.normalized === b.normalized; // å½’ä¸€åŒ–æ¯”è¾ƒ
}
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 0: AST Smart Patch (å˜é‡/å‡½æ•°æ•´ä½“æ›¿æ¢)                                  â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: replaceBlock æ˜¯å®Œæ•´çš„ const/function å®šä¹‰                         â”‚
â”‚  â”œâ”€â”€ ç®—æ³•: è§£æ replaceBlock AST â†’ æå–å˜é‡å â†’ åœ¨æºç ä¸­å®šä½åŒåå®šä¹‰ â†’ æ•´ä½“æ›¿æ¢    â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: const MONSTERS = [...] æ•´ä½“æ›¿æ¢                                      â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 1: Exact Token Match (ç²¾ç¡® Token åŒ¹é…)                                 â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. tokenize(searchBlock) â†’ ['const', 'x', '=', '1', ';']                  â”‚
â”‚  â”‚   2. tokenize(sourceCode) â†’ [...å…¨éƒ¨ tokens...]                             â”‚
â”‚  â”‚   3. æ»‘åŠ¨çª—å£: è¿ç»­åŒ¹é…æ‰€æœ‰ search tokens                                     â”‚
â”‚  â”œâ”€â”€ ç‰¹ç‚¹: å¿½ç•¥ç©ºæ ¼/æ¢è¡Œï¼Œåªæ¯”è¾ƒè¯­ä¹‰å•å…ƒ                                          â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: "const  x=1" å¯ä»¥åŒ¹é… "const x = 1"                                  â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 1.5: Comment-Insensitive Match (æ³¨é‡Šæ— å…³åŒ¹é…) ğŸ†•                       â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: ç²¾ç¡®åŒ¹é…å¤±è´¥ + searchBlock åŒ…å«æ³¨é‡Š                                â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. stripComments(searchBlock) - ç§»é™¤æ‰€æœ‰æ³¨é‡Š                               â”‚
â”‚  â”‚   2. ç”¨å»æ³¨é‡Šçš„ tokens é‡æ–°è¿›è¡Œ Relaxed Match                                â”‚
â”‚  â”œâ”€â”€ ç›®çš„: è§£å†³ AI å¹»è§‰æ·»åŠ æ³¨é‡Š (å¦‚ {/* Fog of War */}) çš„é—®é¢˜                   â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: AI è¾“å‡ºåŒ…å«æ³¨é‡Šï¼Œä½†æºç æ— æ³¨é‡Š â†’ ä»ç„¶èƒ½åŒ¹é…                              â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 2: Relaxed Token Match (å®½æ¾ Token åŒ¹é…)                               â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: relaxedMode = true (ä¸Šä¼ çš„ä»£ç é¦–æ¬¡ç¼–è¾‘)                            â”‚
â”‚  â”œâ”€â”€ ç®—æ³•: LCS (Longest Common Subsequence)                                     â”‚
â”‚  â”‚   - å…è®¸è·³è¿‡éƒ¨åˆ† tokens (å®¹å¿è½»å¾®å·®å¼‚)                                        â”‚
â”‚  â”‚   - é˜ˆå€¼: åŒ¹é…ç‡ > 70%                                                       â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: æºç å¤šäº†ç©ºè¡Œæˆ–æ³¨é‡Šï¼Œä»èƒ½åŒ¹é…                                           â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 3: AST Lite - Function Body Match (å‡½æ•°ä½“åŒ¹é…)                         â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. ä» searchBlock æå–å‡½æ•°å (å¦‚ handleMove)                               â”‚
â”‚  â”‚   2. åœ¨æºç ä¸­å®šä½è¯¥å‡½æ•°çš„å®Œæ•´èŒƒå›´ (start-end)                                  â”‚
â”‚  â”‚   3. æ•´ä½“æ›¿æ¢å‡½æ•°ä½“                                                          â”‚
â”‚  â”œâ”€â”€ ç‰¹ç‚¹: ä¸éœ€è¦ç²¾ç¡®åŒ¹é…å†…å®¹ï¼Œåªéœ€å‡½æ•°ååŒ¹é…                                      â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: function handleMove() {...} æ•´ä½“æ›¿æ¢                                 â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ ç»§ç»­                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy 4: Anchor Matching (é”šç‚¹åŒ¹é…)                                          â”‚
â”‚  â”œâ”€â”€ è§¦å‘æ¡ä»¶: searchBlock åŒ…å«å‹ç¼©æ ‡è®° æˆ– å…¶ä»–ç­–ç•¥å…¨éƒ¨å¤±è´¥                        â”‚
â”‚  â”œâ”€â”€ ç®—æ³•:                                                                      â”‚
â”‚  â”‚   1. å– searchBlock é¦–è¡Œ + æœ«è¡Œä½œä¸º"é”šç‚¹"                                     â”‚
â”‚  â”‚   2. åœ¨æºç ä¸­æŸ¥æ‰¾: é¦–è¡Œå‡ºç°ä½ç½® â†’ åœ¨å…¶å 500 è¡Œå†…æŸ¥æ‰¾æœ«è¡Œ                       â”‚
â”‚  â”‚   3. ç”¨ [é¦–è¡Œä½ç½®, æœ«è¡Œä½ç½®] å®šä¹‰æ›¿æ¢èŒƒå›´                                      â”‚
â”‚  â”œâ”€â”€ ç‰¹ç‚¹: ä¸­é—´å†…å®¹æ— å…³ï¼Œåªå…³å¿ƒè¾¹ç•Œ                                               â”‚
â”‚  â””â”€â”€ ç¤ºä¾‹: é¦–è¡Œ "const MapScreen = () => {" + æœ«è¡Œ "};" â†’ å®šä½æ•´ä¸ªç»„ä»¶           â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»“æŸ | âŒ å¤±è´¥ â†’ æŠ›å‡ºé”™è¯¯                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Safety Nets (å®‰å…¨ç½‘æœºåˆ¶)

**Safety Net 1: AST Dedupe (å»é‡)**
```typescript
// æ£€æµ‹å¹¶åˆ é™¤é‡å¤çš„é¡¶å±‚å®šä¹‰
// åœºæ™¯: AI åŒæ—¶è¾“å‡ºäº†æ–°ç‰ˆæœ¬å’Œä¿ç•™äº†æ—§ç‰ˆæœ¬
dedupeTopLevelBindings(code);
// ç¤ºä¾‹: ä¸¤ä¸ª const MapScreen = ... â†’ åªä¿ç•™åè€…
```

**Safety Net 2: Undefined Reference Detection**
```typescript
// æ£€æµ‹åˆ é™¤äº†å®šä¹‰ä½†ä»æœ‰å¼•ç”¨çš„æƒ…å†µ
detectUndefinedReferences(code);
// ç¤ºä¾‹: AI åˆ é™¤äº† BattleScene å®šä¹‰ï¼Œä½† <BattleScene /> ä»å­˜åœ¨ â†’ å›æ»š
```

**Safety Net 3: Incremental Validation**
```typescript
// æ¯ä¸ª Patch åº”ç”¨åç«‹å³æ ¡éªŒ
validateIncrementalPatch(previousSource, newSource, originalDefinitions, patchIndex);
// æ£€æŸ¥:
// - è¯­æ³•æ˜¯å¦åˆæ³• (Babel parse)
// - æ˜¯å¦ä¸¢å¤±äº†ç»„ä»¶å®šä¹‰
// - æ˜¯å¦äº§ç”Ÿäº†å­¤å„¿ä»£ç  (é¡¶å±‚çš„ hooks è°ƒç”¨)
```

**Safety Net 4: Target Range Restriction**
```typescript
// é™åˆ¶ Patch åªèƒ½åº”ç”¨åˆ° Intent æŒ‡å®šçš„æ–‡ä»¶èŒƒå›´å†…
allowedRanges = findTargetRanges(source, targets);
// é˜²æ­¢: AI çš„ searchBlock æ„å¤–åŒ¹é…åˆ°é”™è¯¯çš„ä½ç½®
```

**ğŸ†• Safety Net 5: Anchor Uniqueness Check (P1 ä¼˜åŒ–)**
```typescript
// ğŸ†• P1 ä¼˜åŒ–: é”šç‚¹åŒ¹é…å‰æ£€æŸ¥é¦–è¡Œæ˜¯å¦å”¯ä¸€
const startOccurrences = sourceLines.filter(l => l.trim() === startLine).length;

if (startOccurrences > 1) {
    console.log(`âš ï¸ Start anchor is not unique (${startOccurrences} occurrences), expanding...`);
    // æ‰©å±•é”šç‚¹: ä½¿ç”¨å‰ 2 è¡Œç»„åˆåŒ¹é…
    const combinedStart = searchLines[0] + '\n' + searchLines[1];
    // æ‰¾åˆ°å”¯ä¸€åŒ¹é…åå†ç»§ç»­
}
```

**ğŸ†• Safety Net 6: Transactional Patching (P1 ä¼˜åŒ–)**
```typescript
// ğŸ†• P1 ä¼˜åŒ–: äº‹åŠ¡æ€§ Patch åº”ç”¨
// æ‰€æœ‰ Patch åœ¨ workingSource å‰¯æœ¬ä¸Šæ‰§è¡Œ
// åªæœ‰å…¨éƒ¨æˆåŠŸæ‰è¿”å›ä¿®æ”¹åçš„ä»£ç 

let workingSource = source; // å·¥ä½œå‰¯æœ¬
const appliedPatches: { index: number; before: string; after: string }[] = [];

// åº”ç”¨æ¯ä¸ª Patch...
appliedPatches.push({ index, before: previousSource, after: workingSource });

// æœ€ç»ˆæ£€æŸ¥
if (failCount > 0 && successCount === 0) {
    throw new Error('æ— æ³•åº”ç”¨ä¿®æ”¹'); // å®Œå…¨å¤±è´¥
}

console.log(`âœ… TRANSACTION COMPLETE: ${successCount} patches applied`);
return workingSource;
```

---

### stripComments å®ç° (æ³¨é‡Šå‰¥ç¦»)

```typescript
function stripComments(code: string): string {
    return code
        .replace(/\{\/\*[\s\S]*?\*\/\}/g, '') // JSX æ³¨é‡Š {/* ... */} (å¿…é¡»å…ˆå¤„ç†)
        .replace(/\/\*[\s\S]*?\*\//g, '')     // å—æ³¨é‡Š /* ... */
        .replace(/\/\/.*/g, '');              // è¡Œæ³¨é‡Š // ...
}
```

**ä¸ºä»€ä¹ˆ JSX æ³¨é‡Šè¦å…ˆå¤„ç†?**
```jsx
// é”™è¯¯é¡ºåº (å…ˆå¤„ç†å—æ³¨é‡Š):
{/* comment */}  â†’  { }  // ç•™ä¸‹ç©ºå¤§æ‹¬å·ï¼Œç ´å JSX

// æ­£ç¡®é¡ºåº (å…ˆå¤„ç† JSX æ³¨é‡Š):
{/* comment */}  â†’  (ç©º)  // å®Œæ•´åˆ é™¤
```

---

### Patch å¤±è´¥å¸¸è§åŸå› 

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `æ‰¾ä¸åˆ°åŒ¹é…çš„ä»£ç å—` | AI çš„ SEARCH å—ä¸æºç ä¸åŒ¹é… | Comment-Insensitive Match (å·²å®ç°) |
| `Patch ç»“æœè¿‡çŸ­` | AI åªè¾“å‡ºäº†éƒ¨åˆ†ä»£ç  | é•¿åº¦æ ¡éªŒ + å›æ»š |
| `é‡å¤å®šä¹‰` | AI æ²¡æœ‰åˆ é™¤æ—§ä»£ç  | AST Dedupe |
| `æœªå®šä¹‰å¼•ç”¨` | AI åˆ é™¤äº†ç»„ä»¶ä½†ç•™ä¸‹äº†ä½¿ç”¨ | Undefined Reference Detection |
| `è¯­æ³•é”™è¯¯` | AI è¾“å‡ºäº†ä¸å®Œæ•´çš„ä»£ç  | validateAndFixSyntax() è‡ªåŠ¨ä¿®å¤ |
| ğŸ†• `é”šç‚¹ä¸å”¯ä¸€` | å¤šä¸ªç›¸åŒçš„ useEffect/å‡½æ•°ç­¾å | Anchor Uniqueness Check + æ‰©å±•é”šç‚¹ |

---

## ğŸ†• ä¼˜åŒ–å†å² (Changelog)

### 2025-12-11 P2 ä¼˜åŒ–

**P2 ä¼˜åŒ– (æŒç»­æ”¹è¿›)**:
5. **Token Normalization**: Token å½’ä¸€åŒ–æå‡åŒ¹é…å®¹é”™
   - è§£å†³: å¼•å·é£æ ¼å·®å¼‚ (`"foo"` vs `'foo'`) å¯¼è‡´çš„è™šå‡ä¸åŒ¹é…
   - æ–°å‡½æ•°: `normalizeToken()`, `tokensEqual()`, `tokenTextEqual()`
   - è§„åˆ™: åŒå¼•å·/æ¨¡æ¿å­—ç¬¦ä¸² â†’ å•å¼•å·å½’ä¸€åŒ–
   - æ–‡ä»¶: `lib/patch.ts`

### 2025-12-11 P0/P1 ä¼˜åŒ–

**P0 ä¼˜åŒ– (ç«‹å³ä¿®å¤)**:
1. **STRICT MODE for RAG**: å½“ DeepSeek è¿”å› targets æ—¶ï¼Œç¦ç”¨ "mentioned in prompt" æ¨¡ç³ŠåŒ¹é…
   - è§£å†³: "screen" åŒ¹é… "LaunchScreen", "DexScreen" çš„å™ªéŸ³é—®é¢˜
   - æ–‡ä»¶: `lib/code-rag.ts`

2. **Data Skeletonization**: çº¯æ•°æ®æ–‡ä»¶ä¸å†ä½¿ç”¨ Brutal Truncate
   - è§£å†³: `VISIBILITY_RADIUS` ç­‰å¸¸é‡è¢«æˆªæ–­ä¸¢å¤±å€¼çš„é—®é¢˜
   - æ–°å‡½æ•°: `dataSkeletonize()` - ä¿ç•™æ‰€æœ‰å¯¼å‡º KEYï¼Œåªæˆªæ–­é•¿ VALUE
   - æ–‡ä»¶: `lib/code-rag.ts`

**P1 ä¼˜åŒ– (çŸ­æœŸ)**:
3. **Anchor Uniqueness Check**: é”šç‚¹åŒ¹é…å‰æ£€æŸ¥é¦–è¡Œå”¯ä¸€æ€§
   - è§£å†³: å¤šä¸ªç›¸åŒ `useEffect` å¯¼è‡´åŒ¹é…é”™ä½çš„é—®é¢˜
   - ç­–ç•¥: é¦–è¡Œä¸å”¯ä¸€æ—¶ï¼Œè‡ªåŠ¨æ‰©å±•ä¸ºå‰ 2 è¡Œç»„åˆåŒ¹é…
   - æ–‡ä»¶: `lib/patch.ts`

4. **Transactional Patching**: äº‹åŠ¡æ€§ Patch åº”ç”¨
   - è§£å†³: éƒ¨åˆ† Patch å¤±è´¥å¯¼è‡´ä»£ç "åŠæ­»ä¸æ´»"çš„é—®é¢˜
   - ç­–ç•¥: åœ¨å‰¯æœ¬ä¸Šæ‰§è¡Œæ‰€æœ‰ Patchï¼Œå…¨éƒ¨æˆåŠŸæ‰æäº¤
   - æ–‡ä»¶: `lib/patch.ts`

---

## é™„å½•: å…³é”®é…ç½®

### Babel Parser é…ç½®
```typescript
export const BABEL_PARSER_CONFIG = {
    sourceType: 'module',
    plugins: [
        'jsx', 'typescript', 'decorators-legacy', 
        'classProperties', 'objectRestSpread',
        'optionalChaining', 'nullishCoalescingOperator',
        'dynamicImport', 'exportDefaultFrom'
    ],
    errorRecovery: true
};
```

### Token åŒ–æ­£åˆ™ (å¸¦å½’ä¸€åŒ–)
```typescript
// åŸºç¡€ Token æå–
const regex = /([a-zA-Z0-9_$]+)|([^\s\w])/g;
// åŒ¹é…:
// - æ ‡è¯†ç¬¦: myVar, useState, $element
// - ç¬¦å·: {, }, (, ), =, ;, <, >
// ä¸åŒ¹é…:
// - ç©ºç™½å­—ç¬¦ (ç©ºæ ¼, æ¢è¡Œ, Tab)

// ğŸ†• Token å½’ä¸€åŒ–
function normalizeToken(text: string): string {
    if (text === '"' || text === '`') return "'";  // å¼•å·å½’ä¸€åŒ–
    return text;
}
```

---

*æœ€åæ›´æ–°: 2025-12-14*

---

## é«˜çº§ RAG ä¼˜åŒ–

> ğŸ’¡ **å¦è§**: [é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾](#é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾-advanced-optimization-roadmap) äº†è§£æ›´å¤š Token ä¼˜åŒ–ç­–ç•¥

> **æ–‡ä»¶ä½ç½®**: [lib/advanced-rag.ts](../lib/advanced-rag.ts)

### 1. è¯­ä¹‰ç¼“å­˜ (Semantic Cache)

è¯­ä¹‰ç¼“å­˜é€šè¿‡ç¼“å­˜ç›¸ä¼¼æŸ¥è¯¢çš„ç»“æœï¼Œé¿å…é‡å¤è°ƒç”¨ LLM è¿›è¡Œæ„å›¾åˆ†ç±»ã€‚

**ä¸¤ç§å®ç°:**

| ç±»å‹ | Text Cache (æ¨è) | Semantic Cache |
|------|-------------------|----------------|
| **ç›¸ä¼¼åº¦ç®—æ³•** | N-gram Jaccard | å‘é‡ä½™å¼¦ç›¸ä¼¼åº¦ |
| **é˜ˆå€¼** | 0.75 (75%) | 0.92 (92%) |
| **éœ€è¦ Embedding** | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ |
| **é€Ÿåº¦** | âš¡ æå¿« (<1ms) | ğŸ¢ è¾ƒæ…¢ (~50ms) |
| **é€‚ç”¨åœºæ™¯** | æ„å›¾åˆ†ç±»ç¼“å­˜ | å¤æ‚è¯­ä¹‰åŒ¹é… |
| **é›†æˆä½ç½®** | `intent-classifier.ts` | é¢„ç•™ |

**Text Cache é…ç½®:**
```typescript
const TEXT_CACHE_CONFIG = {
  maxSize: 200,              // æœ€å¤§æ¡ç›®æ•°
  defaultTTL: 30 * 60 * 1000, // 30 åˆ†é’Ÿ TTL
  similarityThreshold: 0.75,  // 75% Jaccard ç›¸ä¼¼åº¦
  ngramSize: 3               // ä½¿ç”¨ 3-gram
};
```

**å·¥ä½œæµç¨‹:**
```
ç”¨æˆ·æŸ¥è¯¢ â”€â”€â–¶ æå– N-gram â”€â”€â–¶ éå†ç¼“å­˜ â”€â”€â–¶ Jaccard â‰¥ 0.75? â”€â”€â”¬â”€â”€â–¶ âœ… è¿”å›ç¼“å­˜
                                                            â”‚
                                                            â””â”€â”€â–¶ âŒ è°ƒç”¨ LLM â”€â”€â–¶ å­˜å…¥ç¼“å­˜
```

**N-gram Jaccard ç›¸ä¼¼åº¦ç®—æ³•:**
```typescript
// æå– N-gram
function extractNgrams(text: string, n: number): Set<string> {
    const normalized = text.toLowerCase().replace(/\s+/g, ' ').trim();
    const ngrams = new Set<string>();
    for (let i = 0; i <= normalized.length - n; i++) {
        ngrams.add(normalized.slice(i, i + n));
    }
    return ngrams;
}

// Jaccard ç›¸ä¼¼åº¦ = |A âˆ© B| / |A âˆª B|
function jaccardSimilarity(a: Set<string>, b: Set<string>): number {
    const intersection = new Set([...a].filter(x => b.has(x)));
    const union = new Set([...a, ...b]);
    return intersection.size / union.size;
}
```

---

### 2. ç¨‹åºåˆ‡ç‰‡ (Program Slicing)

ç¨‹åºåˆ‡ç‰‡é€šè¿‡æ•°æ®æµåˆ†æï¼Œç²¾ç¡®æå–ä¸ç›®æ ‡å˜é‡ç›¸å…³çš„ä»£ç ï¼Œå‡å°‘ LLM è¾“å…¥ Tokenã€‚

**æ•°æ®æµå›¾èŠ‚ç‚¹:**
```typescript
interface DataFlowNode {
  name: string;           // å˜é‡/å‡½æ•°å
  type: 'variable' | 'function' | 'parameter' | 'import';
  definedAt: number;      // å®šä¹‰è¡Œå·
  usedAt: number[];       // ä½¿ç”¨ä½ç½®åˆ—è¡¨
  dependsOn: string[];    // ä¾èµ–çš„èŠ‚ç‚¹
  dependedBy: string[];   // è¢«ä¾èµ–çš„èŠ‚ç‚¹
}
```

**åˆ‡ç‰‡æ–¹å‘:**
```typescript
function computeProgramSlice(
  code: string,
  targetName: string,
  direction: 'backward' | 'forward' | 'both'
): ProgramSlice | null;
```

| æ–¹å‘ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **backward** | æ‰€æœ‰å½±å“ç›®æ ‡çš„ä»£ç  | `gridColor` â† `INITIAL_COLOR`, `colorConfig` |
| **forward** | æ‰€æœ‰è¢«ç›®æ ‡å½±å“çš„ä»£ç  | `gridColor` â†’ `renderGrid()`, `GridComponent` |
| **both** | åŒå‘åˆ‡ç‰‡ (é»˜è®¤) | å®Œæ•´ä¾èµ–å›¾ |

**ç¤ºä¾‹:**
```
ç›®æ ‡: gridColor

Backward Slice (å½±å“ gridColor çš„):
â”œâ”€â”€ INITIAL_COLOR (å¸¸é‡)
â””â”€â”€ colorConfig (é…ç½®å¯¹è±¡)

Forward Slice (è¢« gridColor å½±å“çš„):
â”œâ”€â”€ renderGrid() (ä½¿ç”¨ gridColor)
â””â”€â”€ GridComponent (æ¸²æŸ“ç»„ä»¶)

å‹ç¼©æ¯”: åŸå§‹ 2000 è¡Œ â†’ åˆ‡ç‰‡ 150 è¡Œ (92.5% å‹ç¼©)
```

---

### 3. åæ€ä»£ç† (Reflection Agent)

åæ€ä»£ç†åœ¨è¡¥ä¸åº”ç”¨æˆåŠŸåè¿›è¡ŒäºŒæ¬¡æ£€æŸ¥ï¼Œç¡®ä¿ç”Ÿæˆçš„ä»£ç æ²¡æœ‰è¯­æ³•é”™è¯¯æˆ–å¼•ç”¨é—®é¢˜ã€‚

**æ£€æŸ¥ç±»å‹:**
```typescript
interface ReflectionError {
  type: 'syntax' | 'reference' | 'type' | 'logic';
  message: string;
  line?: number;
  column?: number;
  severity: 'error' | 'warning';
}
```

**æ£€æŸ¥æµç¨‹:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Reflection Agent Pipeline                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. è¯­æ³•æ£€æŸ¥ (checkSyntax)                                          â”‚
â”‚     â”œâ”€â”€ Babel AST è§£æ                                              â”‚
â”‚     â”œâ”€â”€ æ•è· SyntaxError                                            â”‚
â”‚     â””â”€â”€ æå–é”™è¯¯ä½ç½® (line, column)                                  â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  2. å¼•ç”¨æ£€æŸ¥ (checkReferences)                                       â”‚
â”‚     â”œâ”€â”€ æ”¶é›†æ‰€æœ‰å®šä¹‰:                                                â”‚
â”‚     â”‚   â€¢ VariableDeclarator (å˜é‡)                                 â”‚
â”‚     â”‚   â€¢ FunctionDeclaration (å‡½æ•°)                                â”‚
â”‚     â”‚   â€¢ ImportSpecifier (å¯¼å…¥)                                    â”‚
â”‚     â”œâ”€â”€ è¿‡æ»¤å†…ç½®å…¨å±€å˜é‡ (window, console, React hooks, etc.)        â”‚
â”‚     â””â”€â”€ æ£€æµ‹ä½¿ç”¨ä½†æœªå®šä¹‰çš„æ ‡è¯†ç¬¦                                      â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚  3. ç”Ÿæˆä¿®å¤å»ºè®®                                                     â”‚
â”‚     â””â”€â”€ suggestions: ["å˜é‡ X æœªå®šä¹‰ï¼Œè¯·ç¡®ä¿å¯¼å…¥"]                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®:**
```typescript
const REFLECTION_CONFIG = {
  enableSyntaxCheck: true,      // å¯ç”¨è¯­æ³•æ£€æŸ¥
  enableReferenceCheck: true,   // å¯ç”¨å¼•ç”¨æ£€æŸ¥
  maxErrorsToReport: 10,        // æœ€å¤šæŠ¥å‘Š 10 ä¸ªé”™è¯¯
  autoFixAttempts: 2            // è‡ªåŠ¨ä¿®å¤å°è¯•æ¬¡æ•°
};
```

**é›†æˆä½ç½®:** [lib/self-repair.ts](../lib/self-repair.ts)

è¡¥ä¸æˆåŠŸåè‡ªåŠ¨è°ƒç”¨ `runReflectionCheck()`ï¼š
```typescript
// self-repair.ts
if (patchResult.success) {
    const reflection = runReflectionCheck(patchResult.code);
    if (!reflection.passed) {
        console.warn('[Reflection] Issues found:', reflection.errors);
        // è§¦å‘ä¿®å¤æµç¨‹...
    }
}
```

---

## è‡ªæ„ˆå¾ªç¯ç³»ç»Ÿ

> **æ–‡ä»¶ä½ç½®**: [lib/self-repair.ts](../lib/self-repair.ts)

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Self-Repair Loop (è‡ªæ„ˆå¾ªç¯)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. å°è¯•åº”ç”¨è¡¥ä¸ (applyPatchesWithDetails)                           â”‚
â”‚            â”‚                                                        â”‚
â”‚            â”œâ”€â”€ æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚            â”‚                         â–¼                              â”‚
â”‚            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚            â”‚              â”‚ Reflection Check    â”‚                   â”‚
â”‚            â”‚              â”‚ è¯­æ³• + å¼•ç”¨æ£€æŸ¥      â”‚                   â”‚
â”‚            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚            â”‚                         â”‚                              â”‚
â”‚            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚            â”‚              â–¼                     â–¼                   â”‚
â”‚            â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚        â”‚ é€šè¿‡    â”‚           â”‚ å¤±è´¥    â”‚               â”‚
â”‚            â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â”‚              â”‚                     â”‚                   â”‚
â”‚            â”‚              â–¼                     â”‚                   â”‚
â”‚            â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚                   â”‚
â”‚            â”‚        â”‚ âœ… å®Œæˆ  â”‚                 â”‚                   â”‚
â”‚            â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                   â”‚
â”‚            â”‚                                    â”‚                   â”‚
â”‚            â”œâ”€â”€ å¤±è´¥ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  2. åˆ†æå¤±è´¥åŸå›  (analyzePatchFailure)                               â”‚
â”‚     â”œâ”€â”€ search_mismatch: SEARCH å—æ‰¾ä¸åˆ°åŒ¹é…                         â”‚
â”‚     â”œâ”€â”€ syntax_error: è¡¥ä¸åè¯­æ³•é”™è¯¯                                  â”‚
â”‚     â””â”€â”€ reference_broken: å¼•ç”¨å®Œæ•´æ€§ç ´å                              â”‚
â”‚                                                                     â”‚
â”‚  3. æ„å»ºä¿®å¤æç¤ºè¯ (buildRepairPrompt)                               â”‚
â”‚     â”œâ”€â”€ åŸå§‹ä»£ç                                                      â”‚
â”‚     â”œâ”€â”€ å¤±è´¥çš„è¡¥ä¸                                                   â”‚
â”‚     â”œâ”€â”€ é”™è¯¯ä¿¡æ¯                                                     â”‚
â”‚     â””â”€â”€ åŒ¹é…ä¸Šä¸‹æ–‡ (æœ€ç›¸ä¼¼çš„ä»£ç æ®µ)                                   â”‚
â”‚                                                                     â”‚
â”‚  4. è¯·æ±‚ LLM é‡æ–°ç”Ÿæˆ                                                â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  5. é‡è¯•åº”ç”¨ (attempt < maxRetries)                                  â”‚
â”‚     â”œâ”€â”€ maxRetries = 2                                              â”‚
â”‚     â”œâ”€â”€ æˆåŠŸ â†’ è¿”å›ç»“æœ                                              â”‚
â”‚     â””â”€â”€ å¤±è´¥ â†’ ç»§ç»­å¾ªç¯æˆ–æ”¾å¼ƒ                                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®é¡¹

```typescript
interface SelfRepairConfig {
  maxRetries: number;           // æœ€å¤§é‡è¯•æ¬¡æ•° (é»˜è®¤ 2)
  enableSyntaxCheck: boolean;   // å¯ç”¨è¯­æ³•æ£€æŸ¥
  enableReferenceCheck: boolean; // æ£€æŸ¥å¼•ç”¨å®Œæ•´æ€§
  logLevel: 'silent' | 'normal' | 'verbose';
}
```

---

## æ–‡ä»¶æ˜ å°„ä¸å¯¼å‡ºå‡½æ•°

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | è¡Œæ•° |
|---------|------|------|
| [lib/intent-classifier.ts](../lib/intent-classifier.ts) | æ„å›¾åˆ†ç±» + Text Cache é›†æˆ | ~1300 |
| [lib/code-rag.ts](../lib/code-rag.ts) | RAG æ£€ç´¢ + GraphRAG + è¯­ä¹‰å‹ç¼© | ~3200 |
| [lib/patch.ts](../lib/patch.ts) | è¡¥ä¸åº”ç”¨ + å®‰å…¨ç½‘ + è¡Œå·é”šå®š | ~2200 |
| [lib/self-repair.ts](../lib/self-repair.ts) | è‡ªæ„ˆå¾ªç¯ + Reflection é›†æˆ | ~600 |
| [lib/advanced-rag.ts](../lib/advanced-rag.ts) | é«˜çº§ä¼˜åŒ– (ç¼“å­˜/åˆ‡ç‰‡/åæ€) | ~1000 |
| [lib/ast-parser.ts](../lib/ast-parser.ts) | AST åˆ†æå·¥å…· | ~500 |

### å¯¼å‡ºå‡½æ•°é€ŸæŸ¥

```typescript
// intent-classifier.ts
export { classifyUserIntent, UserIntent, SearchStrategy };

// code-rag.ts
export { 
  chunkCode,                    // ä»£ç åˆ†å—
  findRelevantCodeChunks,       // RAG æ£€ç´¢
  semanticPrecompress,          // P3: è¯­ä¹‰å‹ç¼©
  buildDependencyGraph,         // P2: æ„å»ºä¾èµ–å›¾
  expandContextByGraph,         // P2: GraphRAG æ‰©å±•
  BABEL_PARSER_CONFIG           // Babel é…ç½®å…±äº«
};

// patch.ts
export { 
  applyPatches,                 // è¡¥ä¸åº”ç”¨ (è¿”å›ä»£ç )
  applyPatchesWithDetails,      // è¡¥ä¸åº”ç”¨ (è¿”å›è¯¦æƒ…)
  PatchResult, 
  PatchStats 
};

// self-repair.ts
export { 
  analyzePatchFailure,          // åˆ†æå¤±è´¥åŸå› 
  buildRepairPrompt,            // æ„å»ºä¿®å¤æç¤ºè¯
  RepairResult 
};

// advanced-rag.ts
export {
  // Text Cache (æ¨è)
  queryTextCache,               // æŸ¥è¯¢æ–‡æœ¬ç¼“å­˜
  storeTextCache,               // å­˜å‚¨åˆ°æ–‡æœ¬ç¼“å­˜
  
  // Semantic Cache
  querySemanticCache,           // æŸ¥è¯¢è¯­ä¹‰ç¼“å­˜
  storeSemanticCache,           // å­˜å‚¨åˆ°è¯­ä¹‰ç¼“å­˜
  
  // Program Slicing
  computeProgramSlice,          // è®¡ç®—ç¨‹åºåˆ‡ç‰‡
  buildDataFlowGraph,           // æ„å»ºæ•°æ®æµå›¾
  
  // Reflection Agent
  runReflectionCheck,           // è¿è¡Œåæ€æ£€æŸ¥
  runReflectionWithAutoFix,     // å¸¦è‡ªåŠ¨ä¿®å¤çš„åæ€æ£€æŸ¥
  generateFixPrompt             // ç”Ÿæˆä¿®å¤æç¤ºè¯
};
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| æ„å›¾åˆ†ç±»å»¶è¿Ÿ | < 100ms (æœ¬åœ°) / < 500ms (DeepSeek) | æœ¬åœ°å…³é”®è¯ä¼˜å…ˆ |
| Text Cache å‘½ä¸­ | < 1ms | N-gram æ¯”è¾ƒ |
| RAG æ£€ç´¢å»¶è¿Ÿ | < 300ms | åŒ…å«å‘é‡æœç´¢ |
| è¡¥ä¸åº”ç”¨æˆåŠŸç‡ | > 85% | é¦–æ¬¡å°è¯• |
| è‡ªæ„ˆåæˆåŠŸç‡ | > 95% | åŒ…å«é‡è¯• |
| Text Cache å‘½ä¸­ç‡ | > 40% | é‡å¤/ç›¸ä¼¼æŸ¥è¯¢ |

---

## ä¼˜åŒ–å†å² (Changelog)

### 2025-12-14 âœ… P0-P4 ä¼˜åŒ–å…¨éƒ¨å®æ–½å®Œæˆ
**å®æ–½å®Œæˆ**: P0 Prompt Caching + P1 Type Definitions + P3 PageRank + P4 Unified Diff

**P0: Prompt Caching (ä¸‰çº§ç¼“å­˜ç³»ç»Ÿ)**
- å®ç°æ–‡ä»¶: `lib/prompt-cache.ts` (626 è¡Œ)
- L1: ç³»ç»Ÿæç¤ºè¯ç¼“å­˜ (è·¨ç”¨æˆ·å…±äº«ï¼Œæ°¸ä¸è¿‡æœŸ)
- L2: é¡¹ç›®éª¨æ¶ç¼“å­˜ (10 åˆ†é’Ÿ TTL)
- L3: ä¼šè¯ä¸Šä¸‹æ–‡ç¼“å­˜ (5 åˆ†é’Ÿ TTL)
- æ”¯æŒ DeepSeek + Gemini éšå¼ç¼“å­˜ä¼˜åŒ–

**P1: Type Definitions Generator (ç±»å‹å®šä¹‰ç”Ÿæˆ)**
- å®ç°ä½ç½®: `lib/advanced-rag.ts` - `generateTypeDefinition()`
- é›†æˆä½ç½®: `lib/code-rag.ts` - `applyTrustModeCompression()`
- åŠŸèƒ½: å°†å‚è€ƒæ–‡ä»¶ (files_to_read) è½¬æ¢ä¸º .d.ts é£æ ¼ç±»å‹å®šä¹‰
- å‹ç¼©æ•ˆæœ: 30-50% Token èŠ‚çœ
- æ™ºèƒ½ fallback: ç±»å‹å®šä¹‰æ— æ•ˆæ—¶å›é€€åˆ°éª¨æ¶å‹ç¼©

**P3: GraphRAG PageRank Pruning (ä¾èµ–å›¾å‰ªæ)**
- å®ç°ä½ç½®: `lib/advanced-rag.ts` - `computePageRank()`, `pruneGraphByPageRank()`
- é›†æˆä½ç½®: `lib/code-rag.ts` - GraphRAG æ‰©å±•æµç¨‹
- åŠŸèƒ½: å¯¹ >15 èŠ‚ç‚¹çš„ä¾èµ–å›¾ä½¿ç”¨ PageRank ç®—æ³•æ™ºèƒ½å‰ªæ
- é…ç½®: é˜»å°¼ç³»æ•° 0.85ï¼Œä¿ç•™ top 70%ï¼Œç›®æ ‡èŠ‚ç‚¹è‡ªåŠ¨ boost
- æ•ˆæœ: é˜²æ­¢å¤æ‚é¡¹ç›®ä¸Šä¸‹æ–‡çˆ†ç‚¸

**P4: Unified Diff æ”¯æŒ**
- å®ç°ä½ç½®: `lib/advanced-rag.ts` - `generateUnifiedDiff()`, `applyUnifiedDiff()`
- è¾…åŠ©å‡½æ•°: `isDiffOutput()`, `buildDiffOutputInstructions()`, `selectOutputFormat()`
- åŠŸèƒ½: ç”Ÿæˆå’Œåº”ç”¨ unified diff æ ¼å¼ï¼Œå‡å°‘ 30% è¾“å‡º Token
- ç®—æ³•: åŸºäº LCS (æœ€é•¿å…¬å…±å­åºåˆ—) çš„ diff è®¡ç®—

### 2025-12-19 ğŸš€ é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾ (P0-P4)
**æ–°å¢ç« èŠ‚**: [é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾](#é«˜çº§ä¼˜åŒ–è·¯çº¿å›¾-advanced-optimization-roadmap)
- P0: Prompt Caching (APIçº§ç¼“å­˜) - é¢„æœŸæˆæœ¬é™ä½ 90%
- P1: ç±»å‹å®šä¹‰ (.d.ts) ä»£æ›¿ä»£ç éª¨æ¶ - é¢„æœŸ Token å‡å°‘ 30%
- P3: GraphRAG å‰ªæ (PageRank) - é˜²æ­¢ä¸Šä¸‹æ–‡çˆ†ç‚¸
- P4: Unified Diff è¾“å‡ºæ ¼å¼ - è¾“å‡º Token å‡å°‘ 30%
- å®æ–½è·¯çº¿å›¾ï¼šPhase 1 (1-2å‘¨) â†’ Phase 2 (3-4å‘¨)

### 2025-12-18 è‡ªé€‚åº”å‹ç¼©ç­–ç•¥
- æ–°å¢ 500 è¡Œé˜ˆå€¼å†³ç­–æ ‘
- < 500 è¡Œï¼šå®Œæ•´ä»£ç  + ä¾èµ–å›¾
- â‰¥ 500 è¡Œï¼šè¯­ä¹‰åˆ‡ç‰‡ + ç±»å‹å®šä¹‰
- æ·»åŠ åœºæ™¯å¯¹æ¯”è¡¨æ ¼

### 2025-01-15 é«˜çº§ RAG ä¼˜åŒ–

**P1: è¯­ä¹‰ç¼“å­˜ (Semantic Cache)**
- æ–°å¢ Text Cache (N-gram Jaccard)ï¼Œé›†æˆåˆ° `intent-classifier.ts`
- æ–°å¢ Semantic Cache (å‘é‡ç›¸ä¼¼åº¦)ï¼Œé¢„ç•™åœ¨ `advanced-rag.ts`
- é¢„æœŸæ•ˆæœï¼šå‡å°‘ 40%+ çš„ DeepSeek API è°ƒç”¨

**P2: ç¨‹åºåˆ‡ç‰‡ (Program Slicing)**
- æ–°å¢ `buildDataFlowGraph()` æ•°æ®æµå›¾æ„å»º
- æ–°å¢ `computeProgramSlice()` åŒå‘åˆ‡ç‰‡è®¡ç®—
- é¢„æœŸæ•ˆæœï¼šç²¾ç¡®æå–ç›®æ ‡ç›¸å…³ä»£ç ï¼Œå‡å°‘ 60%+ Token

**P3: åæ€ä»£ç† (Reflection Agent)**
- æ–°å¢ `runReflectionCheck()` è¯­æ³•/å¼•ç”¨æ£€æŸ¥
- é›†æˆåˆ° `self-repair.ts` è¡¥ä¸æˆåŠŸåè°ƒç”¨
- é¢„æœŸæ•ˆæœï¼šå‡å°‘è¯­æ³•é”™è¯¯å’Œå¼•ç”¨é—®é¢˜

### 2025-01-14 Patch ç³»ç»Ÿä¼˜åŒ–

**P1: è¡Œå·é”šå®š (Line Anchoring)**
- è¡¥ä¸æ ¼å¼æ”¯æŒ `@L42-L58` è¡Œå·èŒƒå›´
- ä¼˜å…ˆä½¿ç”¨è¡Œå·å®šä½ï¼Œç›¸ä¼¼åº¦ â‰¥ 70% æ¥å—
- æ–‡ä»¶: `lib/patch.ts`

**P2: å‡½æ•°çº§åˆ†å— (Function-Level Chunking)**
- AST è§£ææŒ‰å‡½æ•°è¾¹ç•Œåˆ†å—
- ä¿ç•™å®Œæ•´å‡½æ•°ä¸Šä¸‹æ–‡
- æ–‡ä»¶: `lib/code-rag.ts`

**P2: GraphRAG å¢å¼º**
- ä¾èµ–å›¾æ„å»º `buildDependencyGraph()`
- æ™ºèƒ½ä¸Šä¸‹æ–‡æ‰©å±• `expandContextByGraph()`
- å‘ä¸‹æ‰©å±•ä¾èµ– + å‘ä¸Šæ‰©å±•è¢«ä¾èµ–
- æ–‡ä»¶: `lib/code-rag.ts`

**P3: è¯­ä¹‰å‹ç¼©é¢„å¤„ç†**
- `semanticPrecompress()` åˆ é™¤æ³¨é‡Š/ç©ºè¡Œ/console.log
- æˆªæ–­è¶…é•¿å­—ç¬¦ä¸²
- èŠ‚çœ 15-25% Token
- æ–‡ä»¶: `lib/code-rag.ts`

### 2025-12-11 P0/P1/P2 ä¼˜åŒ–

**P0: STRICT MODE for RAG**
- å½“ DeepSeek è¿”å› targets æ—¶ï¼Œç¦ç”¨ "mentioned in prompt" æ¨¡ç³ŠåŒ¹é…
- è§£å†³: "screen" åŒ¹é… "LaunchScreen" çš„å™ªéŸ³é—®é¢˜
- æ–‡ä»¶: `lib/code-rag.ts`

**P0: Data Skeletonization**
- çº¯æ•°æ®æ–‡ä»¶ä¸å†ä½¿ç”¨ Brutal Truncate
- ä¿ç•™æ‰€æœ‰å¯¼å‡º KEYï¼Œåªæˆªæ–­é•¿ VALUE
- æ–‡ä»¶: `lib/code-rag.ts`

**P1: Anchor Uniqueness Check**
- é”šç‚¹åŒ¹é…å‰æ£€æŸ¥é¦–è¡Œå”¯ä¸€æ€§
- é¦–è¡Œä¸å”¯ä¸€æ—¶ï¼Œè‡ªåŠ¨æ‰©å±•ä¸ºå‰ 2 è¡Œç»„åˆåŒ¹é…
- æ–‡ä»¶: `lib/patch.ts`

**P1: Transactional Patching**
- äº‹åŠ¡æ€§ Patch åº”ç”¨
- åœ¨å‰¯æœ¬ä¸Šæ‰§è¡Œæ‰€æœ‰ Patchï¼Œå…¨éƒ¨æˆåŠŸæ‰æäº¤
- æ–‡ä»¶: `lib/patch.ts`

**P2: Token Normalization**
- å¼•å·å½’ä¸€åŒ– (`"` â†’ `'`, `` ` `` â†’ `'`)
- è§£å†³å¼•å·é£æ ¼å·®å¼‚å¯¼è‡´çš„è™šå‡ä¸åŒ¹é…
- æ–‡ä»¶: `lib/patch.ts`

---

*æœ€åæ›´æ–°: 2025-01-15*
