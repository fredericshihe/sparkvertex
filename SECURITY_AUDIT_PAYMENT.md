# æ”¯ä»˜æµç¨‹å®‰å…¨å®¡è®¡æŠ¥å‘Š

## ğŸ“Š æ¦‚è¿°
å®¡è®¡æ—¶é—´ï¼š2025-12-05
å®¡è®¡èŒƒå›´ï¼šçˆ±å‘ç”µæ”¯ä»˜é›†æˆï¼ˆè®¢å•åˆ›å»º + Webhook å›è°ƒï¼‰
ä¸¥é‡æ€§è¯„çº§ï¼šğŸ”´ ä¸¥é‡ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ä½

---

## ğŸ”´ ä¸¥é‡æ¼æ´

### 1. é‡å¤æ”¯ä»˜æ¼æ´ï¼ˆRace Conditionï¼‰
**ä¸¥é‡æ€§**: ğŸ”´ **P0 - å·²ä¿®å¤**  
**å½±å“**: ç”¨æˆ·æ”¯ä»˜ 1 æ¬¡å¯è·å¾—å¤šå€ç§¯åˆ†

#### åŸå› åˆ†æ
```
çˆ±å‘ç”µ Webhook é‡è¯•ï¼ˆ3-5æ¬¡ï¼‰
   â†“
æœåŠ¡å™¨æ”¶åˆ° Request A å’Œ Request Bï¼ˆå¹¶å‘ï¼‰
   â†“
A: æ£€æŸ¥ order.status = 'pending' âœ…
B: æ£€æŸ¥ order.status = 'pending' âœ…ï¼ˆA è¿˜æœªæ›´æ–°ï¼‰
   â†“
A: æ›´æ–°è®¢å• + åŠ ç§¯åˆ†ï¼ˆ+100ï¼‰
B: æ›´æ–°è®¢å• + åŠ ç§¯åˆ†ï¼ˆ+100ï¼‰â† é‡å¤ï¼
   â†“
ç»“æœï¼šç”¨æˆ·è·å¾— 200 ç§¯åˆ†
```

#### æŠ€æœ¯ç»†èŠ‚
```typescript
// âŒ æ—§ä»£ç ï¼ˆæœ‰æ¼æ´ï¼‰
if (order.status === 'pending') {
  await update_order({ status: 'paid' });  // â† éåŸå­æ“ä½œ
  const profile = await get_profile();
  await update_credits(profile.credits + order.credits);  // â† å¯èƒ½é‡å¤
}
```

#### ä¿®å¤æ–¹æ¡ˆ
âœ… **å·²å®æ–½**ï¼š
1. **æ•°æ®åº“å‡½æ•°** `process_credit_order`ï¼š
   - ä½¿ç”¨ PostgreSQL `FOR UPDATE` è¡Œçº§é”
   - äº‹åŠ¡å†…å®Œæˆï¼šæ£€æŸ¥çŠ¶æ€ â†’ æ›´æ–°è®¢å• â†’ åŠ ç§¯åˆ†
   - å¹‚ç­‰æ€§æ£€æŸ¥ï¼š`trade_no` å”¯ä¸€æ€§éªŒè¯

2. **ä»£ç å±‚é¢**ï¼š
   - åœ¨è°ƒç”¨æ•°æ®åº“å‡½æ•°å‰å¢åŠ å¹‚ç­‰æ€§æ£€æŸ¥
   - æ£€æŸ¥ `trade_no` æ˜¯å¦å·²è¢«å…¶ä»– `paid` è®¢å•ä½¿ç”¨

```sql
-- å…³é”®ï¼šFOR UPDATE é”ä½è®¢å•è¡Œï¼Œå…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…
SELECT * FROM credit_orders WHERE id = order_id FOR UPDATE;
```

#### éªŒè¯æ–¹æ³•
```bash
# æ¨¡æ‹Ÿå¹¶å‘æµ‹è¯•
ab -n 10 -c 10 -T 'application/json' \
   -p webhook_payload.json \
   https://your-domain.vercel.app/api/payment/afdian/notify
```

---

### 2. é‡‘é¢åŒ¹é…è¯¯åŒ¹é…é£é™©
**ä¸¥é‡æ€§**: ğŸŸ¡ **P1 - éƒ¨åˆ†ç¼“è§£**  
**å½±å“**: A ç”¨æˆ·æ”¯ä»˜å¯èƒ½ç»™ B ç”¨æˆ·åŠ ç§¯åˆ†

#### åœºæ™¯
```
æ—¶é—´çº¿ï¼š
14:00 - ç”¨æˆ· A åˆ›å»º 19.9 å…ƒè®¢å•ï¼ˆæœªæ”¯ä»˜ï¼‰
14:05 - ç”¨æˆ· B åˆ›å»º 19.9 å…ƒè®¢å•å¹¶æ”¯ä»˜
14:05 - Webhook åˆ°è¾¾ï¼ˆæ—  remarkï¼‰
       â†“
ç³»ç»ŸæŒ‰é‡‘é¢åŒ¹é…ï¼šeq('amount', 19.9)
       â†“
å¯èƒ½åŒ¹é…åˆ° A çš„è®¢å•ï¼ˆå¦‚æœæ’åºä¸ç¨³å®šï¼‰
```

#### å½“å‰ç¼“è§£æªæ–½
1. **ä¼˜å…ˆ remark åŒ¹é…**ï¼ˆ99% æƒ…å†µæœ‰æ•ˆï¼‰
2. **æ—¶é—´çª—å£é™åˆ¶**ï¼ˆ10 åˆ†é’Ÿï¼‰
3. **æŒ‰åˆ›å»ºæ—¶é—´å€’åº**

#### æ®‹ç•™é£é™©
- çˆ±å‘ç”µ"å•†å“æ¨¡å¼"ä¸å‘é€ `remark`
- å¦‚æœåŒä¸€ç”¨æˆ·çŸ­æ—¶é—´å†…åˆ›å»ºå¤šä¸ªç›¸åŒé‡‘é¢è®¢å•

#### å»ºè®®æ”¹è¿›
```typescript
// å¢åŠ  user_id å…³è”ï¼ˆéœ€è¦å‰ç«¯ä¼ é€’ï¼‰
const result = await supabaseAdmin
  .from('credit_orders')
  .eq('amount', orderAmount)
  .eq('user_id', expectedUserId)  // â† éœ€è¦ä»æŸå¤„è·å–
  .eq('status', 'pending')
  ...
```

âš ï¸ **é™åˆ¶**ï¼šçˆ±å‘ç”µ Webhook ä¸æä¾› `user_id`ï¼Œéœ€è¦åœ¨åˆ›å»ºè®¢å•æ—¶é¢å¤–å­˜å‚¨æ˜ å°„å…³ç³»ã€‚

---

## ğŸŸ¢ ä½é£é™©é—®é¢˜

### 3. ç­¾åéªŒè¯ Fallback æœºåˆ¶
**ä¸¥é‡æ€§**: ğŸŸ¢ **P2 - éœ€ç›‘æ§**  
**å½±å“**: å¯†é’¥è½®æ¢æ—¶å¯èƒ½å…è®¸æ—§ç­¾å

#### é—®é¢˜
```typescript
// å¦‚æœé…ç½®çš„å…¬é’¥éªŒè¯å¤±è´¥ï¼Œå°è¯•é»˜è®¤å…¬é’¥
if (!isValid && configured_key !== default_key) {
  isValid = tryVerify(default_key);  // â† Fallback
}
```

#### å»ºè®®
1. **åˆ é™¤ Vercel ç¯å¢ƒå˜é‡** `AFDIAN_PUBLIC_KEY`ï¼ˆå½“å‰å·²æ­£ç¡®ï¼‰
2. **ç”Ÿäº§ç¯å¢ƒç¦ç”¨ fallback**ï¼š
   ```typescript
   if (process.env.NODE_ENV === 'production' && fallback_triggered) {
     throw new Error('Key fallback not allowed in production');
   }
   ```

---

## ğŸŒ é«˜å¹¶å‘é—®é¢˜

### 4. çˆ±å‘ç”µ Webhook é‡è¯•
**åœºæ™¯**: 
- Vercel å†·å¯åŠ¨ï¼ˆ>3 ç§’å“åº”ï¼‰
- ç½‘ç»œæŠ–åŠ¨
- æ•°æ®åº“æŸ¥è¯¢æ…¢

**çˆ±å‘ç”µè¡Œä¸º**:
- 3-5 æ¬¡é‡è¯•
- æŒ‡æ•°é€€é¿ï¼ˆ3s, 9s, 27s...ï¼‰

**å½“å‰é˜²æŠ¤**: âœ… å·²é€šè¿‡åŸå­äº‹åŠ¡ + å¹‚ç­‰æ€§æ£€æŸ¥è§£å†³

---

### 5. æ•°æ®åº“è¿æ¥æ± 
**æ½œåœ¨é—®é¢˜**: Vercel Serverless ç¯å¢ƒä¸‹ï¼Œé«˜å¹¶å‘å¯èƒ½è€—å°½æ•°æ®åº“è¿æ¥

**å»ºè®®**:
```typescript
// ä½¿ç”¨ Supabase è¿æ¥æ± é…ç½®
const supabaseAdmin = createClient(url, key, {
  db: {
    pool: {
      max: 10,  // é™åˆ¶æœ€å¤§è¿æ¥æ•°
      idleTimeoutMillis: 30000,
    }
  }
});
```

---

## âœ… å·²ä¿®å¤æ€»ç»“

| æ¼æ´ | ä¸¥é‡æ€§ | çŠ¶æ€ | ä¿®å¤æ–¹å¼ |
|------|--------|------|----------|
| é‡å¤æ”¯ä»˜ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | PostgreSQL è¡Œçº§é” + äº‹åŠ¡ |
| å¹‚ç­‰æ€§ç¼ºå¤± | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | trade_no å”¯ä¸€æ€§æ£€æŸ¥ |
| å¹¶å‘ç«äº‰ | ğŸ”´ P0 | âœ… å·²ä¿®å¤ | FOR UPDATE é” |
| é‡‘é¢è¯¯åŒ¹é… | ğŸŸ¡ P1 | âš ï¸ éƒ¨åˆ† | ä¼˜å…ˆ remark + æ—¶é—´çª—å£ |
| Fallback é£é™© | ğŸŸ¢ P2 | ğŸ“‹ éœ€ç›‘æ§ | ç”Ÿäº§ç¯å¢ƒåº”ç¦ç”¨ |

---

## ğŸ” æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•
```typescript
// tests/payment.test.ts
describe('Payment Idempotency', () => {
  it('should reject duplicate webhook with same trade_no', async () => {
    // ç¬¬ä¸€æ¬¡ webhook
    await POST('/api/payment/afdian/notify', payload1);
    
    // ç¬¬äºŒæ¬¡ç›¸åŒ webhookï¼ˆæ¨¡æ‹Ÿé‡è¯•ï¼‰
    const res = await POST('/api/payment/afdian/notify', payload1);
    
    // ç§¯åˆ†ä¸åº”é‡å¤å¢åŠ 
    expect(res.status).toBe(200);
    expect(userCredits).toBe(initialCredits + orderCredits);  // ä¸æ˜¯ 2x
  });
});
```

### 2. å‹åŠ›æµ‹è¯•
```bash
# ä½¿ç”¨ k6 æˆ– Apache Bench
k6 run --vus 50 --duration 30s load-test.js
```

### 3. ç›‘æ§å‘Šè­¦
- åŒä¸€ `trade_no` å¤šæ¬¡å¤„ç†ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
- è®¢å•çŠ¶æ€å¼‚å¸¸ï¼ˆpending â†’ paid â†’ pendingï¼‰
- ç§¯åˆ†å¼‚å¸¸å¢é•¿ï¼ˆå•ç”¨æˆ·çŸ­æ—¶é—´å†…å¤§é‡å¢åŠ ï¼‰

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] **Supabase Migration**: è¿è¡Œ `20251205_create_process_credit_order_function.sql`
- [ ] **Vercel ç¯å¢ƒå˜é‡**: åˆ é™¤ `AFDIAN_PUBLIC_KEY`ï¼ˆä½¿ç”¨ä»£ç é»˜è®¤å€¼ï¼‰
- [ ] **ç›‘æ§è®¾ç½®**: é…ç½® Vercel Analytics ç›‘æ§ 500 é”™è¯¯
- [ ] **æ—¥å¿—ä¿ç•™**: ç¡®ä¿ webhook æ—¥å¿—ä¿ç•™ 30 å¤©ï¼ˆå®¡è®¡éœ€è¦ï¼‰
- [ ] **å›æ»šè®¡åˆ’**: å¦‚æœ‰é—®é¢˜ï¼Œå›æ»šåˆ° commit `81d990a`

---

## ğŸš€ åç»­ä¼˜åŒ–

1. **Webhook ç­¾åç¼“å­˜**ï¼ˆå‡å°‘éªŒç­¾å¼€é”€ï¼‰
2. **è®¢å•çŠ¶æ€æœº**ï¼ˆpending â†’ processing â†’ paid â†’ completedï¼‰
3. **ç”¨æˆ·ç§¯åˆ†å˜æ›´æ—¥å¿—è¡¨**ï¼ˆå®¡è®¡è¿½è¸ªï¼‰
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼ˆCI/CD é›†æˆæ”¯ä»˜æµç¨‹æµ‹è¯•ï¼‰

---

**å®¡è®¡äººå‘˜**: GitHub Copilot  
**å¤æ ¸å»ºè®®**: å»ºè®®äººå·¥å¤æ ¸æ•°æ®åº“å‡½æ•°æƒé™ï¼ˆSECURITY DEFINERï¼‰
