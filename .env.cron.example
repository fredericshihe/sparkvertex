# 安全修复环境变量配置指南

## P0 & P1: 必需的环境变量

### CRON_SECRET (新增)
用于保护定时任务端点，防止未授权访问

```bash
# 生成随机密钥
openssl rand -base64 32

# 在 Vercel 中设置
CRON_SECRET=your-generated-secret-here
```

### 现有环境变量检查清单

#### 必需变量
- ✅ `NEXT_PUBLIC_SUPABASE_URL`
- ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- ✅ `SUPABASE_SERVICE_ROLE_KEY`
- ✅ `AFDIAN_USER_ID`
- ✅ `AFDIAN_PUBLIC_KEY`

#### 可选变量
- `AFDIAN_STRICT_SIGNATURE` (默认: true)

## 部署步骤

### 1. 在 Vercel 中添加 CRON_SECRET

```bash
vercel env add CRON_SECRET production
# 输入生成的密钥
```

### 2. 在 Supabase 执行迁移

登录 Supabase Dashboard，在 SQL Editor 中执行:

```sql
-- 文件: supabase/migrations/20251206_security_fixes.sql
-- 包含所有安全修复的数据库函数和视图
```

### 3. 配置 Vercel Cron 授权

在 Vercel Dashboard 的 Cron Jobs 设置中:
- 选择 "Use Authorization Header"
- 输入: `Bearer your-cron-secret-here`

### 4. 测试定时任务

```bash
# 本地测试
curl -H "Authorization: Bearer your-cron-secret-here" \
  http://localhost:3000/api/cron/retry-credits

curl -H "Authorization: Bearer your-cron-secret-here" \
  http://localhost:3000/api/cron/health-check

# 生产测试
curl -H "Authorization: Bearer your-cron-secret-here" \
  https://your-domain.com/api/cron/retry-credits
```

## 安全提示

1. **永远不要** 将 CRON_SECRET 提交到 Git
2. 定期轮换密钥（建议每3个月）
3. 使用不同的密钥区分开发/生产环境
4. 监控 Cron 执行日志，及时发现异常

## 监控和告警集成

如需集成告警系统，在 `app/api/cron/health-check/route.ts` 中实现:

### 钉钉机器人
```typescript
async function sendDingTalkAlert(alerts: string[]) {
  await fetch('https://oapi.dingtalk.com/robot/send?access_token=xxx', {
    method: 'POST',
    body: JSON.stringify({
      msgtype: 'text',
      text: { content: alerts.join('\n') }
    })
  });
}
```

### Slack Webhook
```typescript
async function sendSlackAlert(alerts: string[]) {
  await fetch('https://hooks.slack.com/services/xxx', {
    method: 'POST',
    body: JSON.stringify({
      text: alerts.join('\n')
    })
  });
}
```

### 邮件通知
```typescript
// 使用 Resend, SendGrid 或其他邮件服务
import { Resend } from 'resend';
const resend = new Resend(process.env.RESEND_API_KEY);

await resend.emails.send({
  from: 'alerts@yourdomain.com',
  to: 'admin@yourdomain.com',
  subject: '⚠️ Payment System Alert',
  text: alerts.join('\n')
});
```
