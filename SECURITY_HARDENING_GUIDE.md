# 安全加固操作指南 (Security Hardening Guide)

针对当前架构（Next.js + Supabase + 阿里云轻量服务器 + 阿里云 CDN），以下是具体的安全加固步骤。

## 第一步：配置阿里云 CDN 基础防护（控制台操作）

这是第一道防线，在流量到达服务器之前进行拦截。

1.  **登录阿里云 CDN 控制台**。
2.  找到你的域名，点击 **“管理”**。
3.  **访问控制 (Access Control)**:
    *   **IP黑/白名单**: 如果你有发现恶意 IP，直接添加黑名单。
    *   **Referer 防盗链**: 设置为只允许你的域名（如 `*.yourdomain.com`）和空 Referer（可选），防止资源被其他网站盗用。
    *   **URL 鉴权**: (进阶) 如果是付费内容，开启 URL 鉴权。
4.  **频次控制 (Frequency Control)** (关键):
    *   开启 **“IP 访问限频”**。
    *   设置规则：例如，单 IP 在 1 分钟内访问 `/api/` 路径超过 100 次，则返回 403。
    *   *注意：不要设置得太严，以免误伤正常用户（特别是通过公司/学校 NAT 上网的用户）。*

## 第二步：配置轻量服务器防火墙（核心操作）

这是防止“源站 IP 泄露”后被直接攻击的关键。我们要让服务器**只听 CDN 的话**。

这里有两种方案，**强烈推荐方案 B**，因为它维护成本极低且效果很好。

### 方案 A：IP 白名单（标准但繁琐）
阿里云 CDN 的回源 IP 确实是动态的，但它们属于特定的网段（CIDR）。你需要定期获取这些网段并更新到防火墙。

1.  **获取阿里云 CDN 回源 IP 段**:
    *   **方法一（API）**: 使用阿里云 OpenAPI Explorer 调用 `DescribeL2VipsByDomain` 接口查询。
    *   **方法二（文档）**: 搜索“阿里云 CDN 回源网段”，官方文档会不定期更新列表。
    *   *缺点：IP 段非常多（可能有几十个），且会变化，维护极其麻烦。*

### 方案 B：自定义 Header 鉴权（推荐，简单有效）
原理：给 CDN 贴个“通行证”。我们在 CDN 回源时自动带上一个秘密的 Header，服务器只认这个 Header，没有“通行证”的请求（比如直接扫描 IP 的攻击者）直接拒之门外。

1.  **在阿里云 CDN 设置“通行证”**:
    *   登录 CDN 控制台 -> 域名管理 -> 点击你的域名 -> **回源配置**。
    *   找到 **“回源 HTTP 请求头”**，点击添加。
    *   **参数**: `X-Source-Auth` (或者你自己起个名字，如 `X-Spark-Secret`)
    *   **取值**: 生成一个复杂的随机字符串（例如 `spark-vertex-secure-token-2025`）。
    *   点击确定。

2.  **在 Next.js 中间件验证“通行证”**:
    *   *(代码已在 `middleware.ts` 中更新，请查看文件变更)*
    *   中间件会检查每个请求是否包含这个 Header。如果不包含或不匹配，直接返回 403 Forbidden。

3.  **配合防火墙（可选但推荐）**:
    *   即使用了 Header 鉴权，如果能配合防火墙限制 IP 更好。如果觉得 IP 太多太麻烦，至少可以把防火墙的 80/443 端口限制为**“只允许中国境内的 IP”**（如果你的用户都在国内），或者保持开放，完全依赖 Header 鉴权和限流。

## 第三步：隐藏 Supabase 数据库端口

如果你的 Supabase 是通过 Docker 部署在同一台服务器上，不要让数据库端口暴露在公网。

1.  **修改 `docker-compose.yml`**:
    *   找到 `db` (Postgres) 和 `studio` 等服务的 `ports` 配置。
    *   将 `0.0.0.0:5432:5432` 改为 `127.0.0.1:5432:5432`。
    *   这样数据库端口只允许服务器内部（Next.js）访问，公网扫描不到。
2.  **重启 Supabase**:
    *   `docker-compose down && docker-compose up -d`

## 第四步：Next.js 应用层限流 (代码实现)

在 `middleware.ts` 中添加简单的限流逻辑，作为最后一道防线。

*(代码已在 `middleware.ts` 中更新，请查看文件变更)*

## 第五步：监控与应急

1.  **监控 CPU/带宽**: 在轻量服务器控制台设置报警，CPU 持续 > 80% 或带宽跑满时发送短信。
2.  **应急预案**:
    *   如果遭遇大流量攻击导致 CDN 停用（黑洞），立即在 DNS 解析处将域名暂时解析到 `127.0.0.1`，防止源站 IP 进一步暴露，等待攻击停止。
