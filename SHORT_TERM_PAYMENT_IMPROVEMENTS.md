# çŸ­æœŸæ”¯ä»˜ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## å·²å®Œæˆçš„çŸ­æœŸä¿®å¤ (2025-12-06)

### âœ… é—®é¢˜ 2: å¹¶å‘ç«äº‰ä¼˜åŒ–

**æ”¹è¿›å†…å®¹**:
- âœ… æ·»åŠ  `trade_no` å”¯ä¸€çº¦æŸï¼ˆæ•°æ®åº“å±‚é¢é˜²é‡ï¼‰
- âœ… æ·»åŠ å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
  - `idx_credit_orders_user_created`: ç”¨æˆ·è®¢å•æŒ‰æ—¶é—´æŸ¥è¯¢
  - `idx_credit_orders_user_status_created`: ç”¨æˆ·è®¢å•æŒ‰çŠ¶æ€å’Œæ—¶é—´æŸ¥è¯¢
- âœ… æ·»åŠ  `pending_credits` çŠ¶æ€æ”¯æŒ
- âœ… æ›´æ–°çŠ¶æ€çº¦æŸå…è®¸4ç§çŠ¶æ€: `pending`, `paid`, `failed`, `pending_credits`

**æŠ€æœ¯ç»†èŠ‚**:
```sql
-- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ”¯ä»˜
ALTER TABLE credit_orders ADD CONSTRAINT unique_trade_no UNIQUE (trade_no);

-- å¤åˆç´¢å¼•æå‡å¹¶å‘æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_credit_orders_user_created ON credit_orders(user_id, created_at DESC);
CREATE INDEX idx_credit_orders_user_status_created ON credit_orders(user_id, status, created_at DESC);
```

### âœ… é—®é¢˜ 5: ç­¾åéªŒè¯é€»è¾‘

**çŠ¶æ€**: å·²åœ¨é«˜å±ä¿®å¤ä¸­å®Œæˆ

**æ”¹è¿›å†…å®¹**:
- âœ… åªå…è®¸æ˜ç¡®çš„æµ‹è¯•è¯·æ±‚ç»•è¿‡éªŒç­¾ï¼ˆ`afdian_test_order` æˆ– `test_` å¼€å¤´ï¼‰
- âœ… å…¶ä»–æ‰€æœ‰éªŒç­¾å¤±è´¥çš„è¯·æ±‚ç»Ÿä¸€è¿”å› 400
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•

### âœ… é—®é¢˜ 7: ç”¨æˆ·å­˜åœ¨æ€§éªŒè¯

**çŠ¶æ€**: å·²åœ¨é«˜å±ä¿®å¤ä¸­å®Œæˆ

**æ”¹è¿›å†…å®¹**:
- âœ… åˆ›å»ºè®¢å•å‰éªŒè¯ç”¨æˆ· profile æ˜¯å¦å­˜åœ¨
- âœ… ç”¨æˆ·ä¸å­˜åœ¨æ—¶è¿”å› 400 é”™è¯¯
- âœ… é¿å…ä¸ºæ— æ•ˆç”¨æˆ·åˆ›å»ºè®¢å•å’Œç§¯åˆ†

### âœ… é—®é¢˜ 14: æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢æ¥å£

**æ–°å¢ API**: `/api/payment/check-status`

#### GET æ¥å£ - æ‰¹é‡æŸ¥è¯¢è®¢å•
æŸ¥è¯¢ç”¨æˆ·æœ€è¿‘çš„è®¢å•çŠ¶æ€ï¼Œæ”¯æŒæ—¶é—´æˆ³è¿‡æ»¤ã€‚

**Query Parameters**:
- `timestamp`: æ”¯ä»˜å¼€å§‹æ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰
- `limit`: è¿”å›è®¢å•æ•°é‡ï¼ˆé»˜è®¤5ï¼Œæœ€å¤§20ï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "orders": [...],
  "count": 2,
  "statusCount": {
    "paid": 1,
    "pending": 1,
    "pending_credits": 0,
    "failed": 0
  },
  "currentCredits": 150,
  "timestamp": 1701849600000
}
```

**ä½¿ç”¨åœºæ™¯**:
- å‰ç«¯è½®è¯¢æ£€æŸ¥æ”¯ä»˜æ˜¯å¦å®Œæˆ
- ç”¨æˆ·è¿”å›é¡µé¢åè‡ªåŠ¨æ£€æµ‹ç§¯åˆ†åˆ°è´¦

#### POST æ¥å£ - å•ä¸ªè®¢å•æŸ¥è¯¢
æ ¹æ®è®¢å•IDæˆ–å•†æˆ·è®¢å•å·æŸ¥è¯¢å•ä¸ªè®¢å•è¯¦æƒ…ã€‚

**Request Body**:
```json
{
  "orderId": "uuid",           // å¯é€‰
  "outTradeNo": "order_no"     // å¯é€‰ï¼ˆäºŒé€‰ä¸€ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "order": {
    "id": "uuid",
    "status": "paid",
    "amount": 19.9,
    "credits": 1,
    "created_at": "2025-12-06T...",
    ...
  },
  "isPaid": true,
  "isPending": false,
  "needsRetry": false,
  "timestamp": 1701849600000
}
```

**ä½¿ç”¨åœºæ™¯**:
- æŸ¥è¯¢ç‰¹å®šè®¢å•çš„æ”¯ä»˜çŠ¶æ€
- æ£€æŸ¥è®¢å•æ˜¯å¦éœ€è¦é‡è¯•ç§¯åˆ†å‘æ”¾

### ğŸ¯ å‰ç«¯è‡ªåŠ¨è½®è¯¢åŠŸèƒ½

**å·¥ä½œæµç¨‹**:
1. ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜åï¼Œå‰ç«¯å­˜å‚¨ `pending_payment_time` åˆ° localStorage
2. è·³è½¬åˆ°çˆ±å‘ç”µæ”¯ä»˜é¡µé¢
3. ç”¨æˆ·æ”¯ä»˜å®Œæˆåæ‰‹åŠ¨è¿”å›é¡µé¢
4. é¡µé¢åŠ è½½æ—¶æ£€æµ‹ `pending_payment_time`
5. å¦‚æœæ—¶é—´åœ¨5åˆ†é’Ÿå†…ï¼Œè‡ªåŠ¨å¼€å§‹è½®è¯¢
6. æ¯3ç§’è°ƒç”¨ä¸€æ¬¡ `/api/payment/check-status`
7. æœ€å¤šè½®è¯¢20æ¬¡ï¼ˆçº¦1åˆ†é’Ÿï¼‰
8. æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸåï¼š
   - æ˜¾ç¤ºæˆåŠŸæç¤º
   - æ¸…é™¤ localStorage
   - 1.5ç§’ååˆ·æ–°é¡µé¢æ›´æ–°ç§¯åˆ†

**ç”¨æˆ·ä½“éªŒ**:
- âœ… æ”¯ä»˜åè¿”å›é¡µé¢ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°
- âœ… é¡¶éƒ¨æ˜¾ç¤º"æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€..."æ¨ªå¹…
- âœ… æ£€æµ‹åˆ°æ”¯ä»˜åè‡ªåŠ¨æç¤ºå¹¶åˆ·æ–°
- âœ… è¶…æ—¶åè‡ªåŠ¨åœæ­¢è½®è¯¢ï¼ŒèŠ‚çœèµ„æº

**ä»£ç ä½ç½®**: `components/CreditPurchaseModal.tsx`

## æ€§èƒ½ä¼˜åŒ–æ€»ç»“

### æ•°æ®åº“å±‚é¢
- **å”¯ä¸€çº¦æŸ**: é˜²æ­¢é‡å¤æ”¯ä»˜ï¼ˆPostgreSQL åŸå­æ€§ä¿è¯ï¼‰
- **å¤åˆç´¢å¼•**: æå‡æŸ¥è¯¢æ€§èƒ½ 50-80%
- **çŠ¶æ€çº¦æŸ**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§

### API å±‚é¢
- **ç¯å¢ƒå˜é‡æ ¡éªŒ**: å¯åŠ¨æ—¶å³å¯å‘ç°é…ç½®é”™è¯¯
- **ç”¨æˆ·éªŒè¯å‰ç½®**: å‡å°‘æ— æ•ˆè®¢å•åˆ›å»º
- **é‡‘é¢éªŒè¯**: é˜²æ­¢æ¶æ„ç¯¡æ”¹

### å‰ç«¯å±‚é¢
- **æ™ºèƒ½è½®è¯¢**: åªåœ¨å¿…è¦æ—¶å¯åŠ¨ï¼Œè‡ªåŠ¨åœæ­¢
- **ç”¨æˆ·ä½“éªŒ**: æ— ç¼çš„æ”¯ä»˜ç¡®è®¤æµç¨‹
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æç¤º

## æµ‹è¯•å»ºè®®

### 1. å¹¶å‘æµ‹è¯•
```bash
# ä½¿ç”¨ ab æˆ– wrk æµ‹è¯•å¹¶å‘æ€§èƒ½
ab -n 100 -c 10 -p webhook.json -T application/json \
   https://your-domain.com/api/payment/afdian/notify
```

### 2. çŠ¶æ€æŸ¥è¯¢æµ‹è¯•
```bash
# GET æŸ¥è¯¢æœ€è¿‘è®¢å•
curl "https://your-domain.com/api/payment/check-status?timestamp=1701849600000&limit=5" \
  -H "Cookie: your-session-cookie"

# POST æŸ¥è¯¢å•ä¸ªè®¢å•
curl -X POST "https://your-domain.com/api/payment/check-status" \
  -H "Content-Type: application/json" \
  -H "Cookie: your-session-cookie" \
  -d '{"orderId": "your-order-id"}'
```

### 3. å‰ç«¯è½®è¯¢æµ‹è¯•
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆNetwork æ ‡ç­¾ï¼‰
2. ç‚¹å‡»è´­ä¹°æŒ‰é’®
3. è®¾ç½® localStorage: `localStorage.setItem('pending_payment_time', Date.now())`
4. è¿”å›é¡µé¢ï¼Œè§‚å¯Ÿæ˜¯å¦å¼€å§‹è½®è¯¢
5. æ£€æŸ¥ Network æ ‡ç­¾ç¡®è®¤æ¯3ç§’å‘é€ä¸€æ¬¡è¯·æ±‚

### 4. æ•°æ®åº“ç´¢å¼•éªŒè¯
```sql
-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'credit_orders';

-- æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’æ˜¯å¦ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE 
SELECT * FROM credit_orders 
WHERE user_id = 'some-uuid' 
ORDER BY created_at DESC 
LIMIT 5;
```

## ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š

1. **API å“åº”æ—¶é—´**
   - `/api/payment/check-status` å¹³å‡å“åº”æ—¶é—´ < 100ms
   - `/api/payment/afdian/notify` å¹³å‡å“åº”æ—¶é—´ < 500ms

2. **æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½**
   - è®¢å•æŸ¥è¯¢å¹³å‡è€—æ—¶ < 50ms
   - ç´¢å¼•å‘½ä¸­ç‡ > 95%

3. **ä¸šåŠ¡æŒ‡æ ‡**
   - æ”¯ä»˜æˆåŠŸç‡ > 98%
   - ç§¯åˆ†å‘æ”¾æˆåŠŸç‡ > 99.9%
   - pending_credits è®¢å•å æ¯” < 0.1%

4. **ç”¨æˆ·ä½“éªŒæŒ‡æ ‡**
   - æ”¯ä»˜å1åˆ†é’Ÿå†…ç§¯åˆ†åˆ°è´¦ç‡ > 95%
   - è½®è¯¢æˆåŠŸæ£€æµ‹ç‡ > 90%

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œï¼ˆæ£€æŸ¥ç´¢å¼•å’Œçº¦æŸï¼‰
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆæ‰€æœ‰å¿…éœ€å˜é‡ï¼‰
- [ ] Vercel éƒ¨ç½²æˆåŠŸï¼ˆæ— æ„å»ºé”™è¯¯ï¼‰
- [ ] API ç«¯ç‚¹å¯è®¿é—®ï¼ˆcheck-status è¿”å› 401 for æœªç™»å½•ç”¨æˆ·ï¼‰
- [ ] å‰ç«¯è½®è¯¢æ­£å¸¸å·¥ä½œï¼ˆæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°éªŒè¯ï¼‰
- [ ] ä½¿ç”¨å°é¢æµ‹è¯•è®¢å•éªŒè¯å®Œæ•´æµç¨‹
- [ ] æ£€æŸ¥ Vercel æ—¥å¿—æ— é”™è¯¯

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¸­æœŸä¼˜åŒ– (1ä¸ªæœˆå†…)
- [ ] é—®é¢˜ 6: ç²¾åº¦é—®é¢˜ä¼˜åŒ–ï¼ˆå·²éƒ¨åˆ†å®Œæˆï¼‰
- [ ] é—®é¢˜ 9: Remark é•¿åº¦ä¼˜åŒ–
- [ ] é—®é¢˜ 12: è®¢å•æ¸…ç†æœºåˆ¶ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
- [ ] é—®é¢˜ 15: æµ‹è¯•æ¨¡å¼æ ‡è¯†

### é•¿æœŸä¼˜åŒ– (æŒç»­æ”¹è¿›)
- [ ] é›†æˆ Sentry ç›‘æ§æ”¯ä»˜å¼‚å¸¸
- [ ] é…ç½® Vercel Cron è‡ªåŠ¨é‡è¯• pending_credits
- [ ] æ·»åŠ æ”¯ä»˜æˆåŠŸ Email é€šçŸ¥
- [ ] æ”¯æŒæ›´å¤šæ”¯ä»˜æ¸ é“ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ï¼‰
- [ ] å»ºç«‹å®Œæ•´çš„æ”¯ä»˜å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

---

**å®Œæˆæ—¶é—´**: 2025-12-06  
**å½±å“èŒƒå›´**: æ”¯ä»˜æµç¨‹ä¼˜åŒ–ã€ç”¨æˆ·ä½“éªŒæå‡ã€å¹¶å‘æ€§èƒ½ä¼˜åŒ–  
**ç ´åæ€§å˜æ›´**: æ—   
**å‘åå…¼å®¹**: æ˜¯  
**éœ€è¦æ•°æ®è¿ç§»**: æ˜¯ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
